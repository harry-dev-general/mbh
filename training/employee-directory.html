<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Directory - MBH Staff Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f4f8;
            color: #333;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.3);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-white {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .btn-white:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        .controls {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .search-box {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            max-width: 400px;
        }
        
        .search-box input {
            flex: 1;
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #DC143C;
        }
        
        .filters {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .employee-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .active-roster-cell {
            text-align: center;
        }
        
        .roster-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .hours-cell {
            font-weight: 500;
        }
        
        .availability-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .status-submitted {
            background: #d4edda;
            color: #155724;
        }
        
        .status-pending {
            background: #fff3e0;
            color: #ff9800;
        }
        
        .status-not-submitted {
            background: #f8d7da;
            color: #721c24;
        }
        
        .staff-type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .staff-type-badge.full-time {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .staff-type-badge.casual {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }
        
        .btn-primary {
            background: #DC143C;
            color: white;
            border: none;
        }
        
        .btn-primary:hover {
            background: #8B0000;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #DC143C;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Leave Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #333;
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #DC143C;
        }
        
        .form-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        
        .week-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .week-display {
            font-weight: 500;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                max-width: none;
            }
            
            .employee-table {
                overflow-x: auto;
            }
            
            table {
                min-width: 800px;
            }
        }
        
        /* Monthly Calendar Styles */
        .monthly-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e0e0e0;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .calendar-header {
            padding: 0.5rem;
            text-align: center;
            font-weight: 600;
            background: #f5f5f5;
            color: #666;
            font-size: 0.9rem;
        }
        
        .calendar-day {
            background: white;
            min-height: 80px;
            padding: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .calendar-day.other-month {
            background: #fafafa;
            color: #ccc;
        }
        
        .calendar-day.today {
            background: #fffbf0;
        }
        
        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #333;
        }
        
        .calendar-day.other-month .calendar-day-number {
            color: #ccc;
        }
        
        .leave-block {
            font-size: 0.75rem;
            padding: 2px 4px;
            margin: 1px 0;
            border-radius: 2px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }
        
        .leave-block:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .leave-block.annual-leave { background: #4caf50; }
        .leave-block.sick-leave { background: #ff9800; }
        .leave-block.personal-leave { background: #2196f3; }
        .leave-block.public-holiday { background: #9c27b0; }
        .leave-block.other { background: #9e9e9e; }
        
        .leave-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            z-index: 1000;
            pointer-events: none;
            display: none;
            white-space: nowrap;
        }
        
        .day-schedule {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .day-schedule:last-child {
            border-bottom: none;
        }
        
        .day-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 120px;
        }
        
        .day-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .day-checkbox label {
            font-weight: 500;
            cursor: pointer;
        }
        
        .time-inputs {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }
        
        .time-inputs input {
            width: 100px;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .time-inputs input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1><i class="fas fa-users"></i> Employee Directory</h1>
            <div>
                <a href="management-dashboard.html?tab=staff" class="btn btn-white">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
                <button class="btn btn-white" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="controls">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search employees...">
            </div>
            
            <div class="filters">
                <label class="filter-checkbox">
                    <input type="checkbox" id="activeOnly" checked>
                    <span>Active Roster Only</span>
                </label>
                
                <label class="filter-checkbox">
                    <input type="checkbox" id="pendingOnly">
                    <span>Pending Availability</span>
                </label>
            </div>
            
            <div class="week-selector">
                <button class="btn btn-secondary btn-small" onclick="changeWeek(-1)">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span class="week-display" id="weekDisplay">Loading...</span>
                <button class="btn btn-secondary btn-small" onclick="changeWeek(1)">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <div class="employee-table">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Staff Type</th>
                        <th style="text-align: center;">Active Roster</th>
                        <th>Hours This Week</th>
                        <th>Availability Status</th>
                        <th>Leave Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="employeeList">
                    <tr>
                        <td colspan="9" class="loading">
                            <div class="spinner"></div>
                            <p>Loading employees...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Monthly Leave Calendar -->
    <div style="margin-top: 2rem; padding: 1.5rem; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0; color: #333; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-calendar-alt"></i> Leave Calendar
            </h2>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button class="week-nav" onclick="navigateMonth(-1)">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span id="monthDisplay" style="font-weight: 600; min-width: 150px; text-align: center;"></span>
                <button class="week-nav" onclick="navigateMonth(1)">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <button class="week-nav" onclick="goToCurrentMonth()" style="padding: 0.5rem 1rem;">
                    Today
                </button>
            </div>
        </div>
        
        <div id="monthlyCalendar" class="monthly-calendar">
            <!-- Calendar will be rendered here -->
        </div>
        
        <!-- Leave Legend -->
        <div style="margin-top: 1rem; display: flex; gap: 2rem; flex-wrap: wrap; font-size: 0.9rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="width: 16px; height: 16px; background: #4caf50; border-radius: 2px;"></div>
                <span>Annual Leave</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="width: 16px; height: 16px; background: #ff9800; border-radius: 2px;"></div>
                <span>Sick Leave</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="width: 16px; height: 16px; background: #2196f3; border-radius: 2px;"></div>
                <span>Personal Leave</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="width: 16px; height: 16px; background: #9c27b0; border-radius: 2px;"></div>
                <span>Public Holiday</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="width: 16px; height: 16px; background: #9e9e9e; border-radius: 2px;"></div>
                <span>Other</span>
            </div>
        </div>
    </div>

    <!-- Leave/Holiday Modal -->
    <div id="leaveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Block Leave/Holiday</h2>
                <button class="close-btn" onclick="closeLeaveModal()">&times;</button>
            </div>
            
            <form id="leaveForm">
                <input type="hidden" id="leaveEmployeeId">
                <input type="hidden" id="leaveEmployeeName">
                
                <div class="form-group">
                    <label class="form-label">Employee</label>
                    <input type="text" class="form-input" id="leaveEmployeeDisplay" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Leave Type</label>
                    <select class="form-input" id="leaveType" required>
                        <option value="">Select type...</option>
                        <option value="Annual Leave">Annual Leave</option>
                        <option value="Sick Leave">Sick Leave</option>
                        <option value="Personal Leave">Personal Leave</option>
                        <option value="Public Holiday">Public Holiday</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Start Date</label>
                    <input type="date" class="form-input" id="leaveStartDate" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-input" id="leaveEndDate" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" id="leaveNotes" rows="3"></textarea>
                </div>
                
                <div class="form-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeLeaveModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Leave</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Fixed Availability Modal -->
    <div id="fixedAvailabilityModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Edit Fixed Weekly Availability</h2>
                <button class="close-btn" onclick="closeFixedAvailabilityModal()">&times;</button>
            </div>
            
            <form id="fixedAvailabilityForm">
                <input type="hidden" id="fixedEmployeeId">
                
                <div class="form-group">
                    <label class="form-label">Employee</label>
                    <input type="text" class="form-input" id="fixedEmployeeDisplay" readonly>
                </div>
                
                <div style="border: 1px solid #ddd; border-radius: 4px; padding: 1rem; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 1rem 0; color: #333;">Weekly Schedule</h4>
                    
                    <div id="fixedDaysContainer">
                        <!-- Days will be generated here -->
                    </div>
                </div>
                
                <div class="form-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeFixedAvailabilityModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Fixed Availability</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://etkugeooigiwahikrmzr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0a3VnZW9vaWdpd2FoaWtybXpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4MDI0OTcsImV4cCI6MjA2ODM3ODQ5N30.OPIYLsnPNNF7dP3SDCODIurzaa3X_Q3xEhfPO3rLJxU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Airtable configuration
        const AIRTABLE_API_KEY = 'patYiJdXfvcSenMU4.f16c95bde5176be23391051e0c5bdc6405991805c434696d55b851bf208a2f14';
        const BASE_ID = 'applkAFOn2qxtu7tx';
        const EMPLOYEE_TABLE_ID = 'tbltAE4NlNePvnkpY';
        const AVAILABILITY_TABLE_ID = 'tblcBoyuVsbB1dt1I';
        const ALLOCATIONS_TABLE_ID = 'tbl22YKtQXZtDFtEX';
        const LEAVE_TABLE_ID = 'tblTBEimQK9vyWs8r';

        // State
        let employeeData = [];
        let availabilityData = [];
        let allocationsData = [];
        let currentWeekStart = null;
        let leaveData = []; // Store leave records from Airtable
        let currentMonth = null; // Current month being displayed
        let employeeMap = {}; // Map employee IDs to names

        // Check authentication
        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = 'auth.html';
                return;
            }

            // Check if user is management
            const managementEmails = [
                'harry@priceoffice.com.au',
                'mmckelvey03@gmail.com',
                'manager@mbh.com',
                'admin@mbh.com',
                'operations@mbh.com'
            ];

            if (!managementEmails.includes(user.email.toLowerCase()) && 
                !user.email.includes('@mbh.com')) {
                // Not a management user, redirect to regular dashboard
                window.location.href = 'dashboard.html';
                return;
            }

            // Initialize data
            initializeWeek();
            initializeMonth();
            loadEmployeeData();
        }

        // Initialize current week
        function initializeWeek() {
            const today = new Date();
            today.setFullYear(2025); // Ensure 2025 context
            currentWeekStart = getMonday(today);
            updateWeekDisplay();
        }
        
        // Load leave data from Airtable
        async function loadLeaveData() {
            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${BASE_ID}/${LEAVE_TABLE_ID}?pageSize=100`,
                    {
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const result = await response.json();
                    // Filter out cancelled leaves client-side
                    leaveData = (result.records || []).filter(record => 
                        record.fields['Status'] !== 'Cancelled'
                    );
                    console.log(`Loaded ${leaveData.length} active leave records from Airtable`);
                    
                    // Debug: Show all leave records
                    if (leaveData.length > 0) {
                        console.log('Leave records:', leaveData.map(r => ({
                            employee: r.fields['Employee'],
                            type: r.fields['Leave Type'],
                            startDate: r.fields['Start Date'],
                            endDate: r.fields['End Date'],
                            status: r.fields['Status']
                        })));
                    }
                } else {
                    console.error('Failed to fetch leave data:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('Error loading leave data:', error);
            }
        }
        
        // Check if employee is on leave
        function getLeaveStatus(employeeId) {
            const today = new Date();
            today.setFullYear(2025);
            const todayStr = formatDate(today);
            
            const employeeLeaves = leaveData.filter(record => 
                record.fields['Employee'] && 
                record.fields['Employee'][0] === employeeId &&
                record.fields['Status'] === 'Approved'
            );
            
            const currentLeave = employeeLeaves.find(record => {
                const leave = record.fields;
                return leave['Start Date'] <= todayStr && leave['End Date'] >= todayStr;
            });
            
            if (currentLeave) {
                return {
                    onLeave: true,
                    type: currentLeave.fields['Leave Type'],
                    endDate: currentLeave.fields['End Date']
                };
            }
            
            return { onLeave: false };
        }

        // Get Monday of week
        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        // Format date
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Update week display
        function updateWeekDisplay() {
            const endDate = new Date(currentWeekStart);
            endDate.setDate(endDate.getDate() + 6);
            
            const options = { month: 'short', day: 'numeric' };
            const startStr = currentWeekStart.toLocaleDateString('en-AU', options);
            const endStr = endDate.toLocaleDateString('en-AU', options);
            
            document.getElementById('weekDisplay').textContent = `${startStr} - ${endStr}`;
        }

        // Change week
        function changeWeek(direction) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
            updateWeekDisplay();
            loadEmployeeData();
        }
        
        // Initialize current month
        function initializeMonth() {
            const today = new Date();
            today.setFullYear(2025);
            currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            updateMonthDisplay();
            renderMonthlyCalendar();
        }
        
        // Update month display
        function updateMonthDisplay() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('monthDisplay').textContent = 
                `${monthNames[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
        }
        
        // Navigate month
        function navigateMonth(direction) {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + direction, 1);
            updateMonthDisplay();
            renderMonthlyCalendar();
        }
        
        // Go to current month
        function goToCurrentMonth() {
            const today = new Date();
            today.setFullYear(2025);
            currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            updateMonthDisplay();
            renderMonthlyCalendar();
        }
        
        // Render monthly calendar
        function renderMonthlyCalendar() {
            const calendar = document.getElementById('monthlyCalendar');
            if (!calendar) return; // Calendar not yet in DOM
            
            calendar.innerHTML = '';
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                header.textContent = day;
                calendar.appendChild(header);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            const prevLastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 0);
            
            // Calculate start date (include previous month days)
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // Today for highlighting
            const today = new Date();
            today.setFullYear(2025);
            const todayStr = formatDate(today);
            
            // Generate 42 days (6 weeks)
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                
                // Check if other month
                if (date.getMonth() !== currentMonth.getMonth()) {
                    dayDiv.classList.add('other-month');
                }
                
                // Check if today
                if (formatDate(date) === todayStr) {
                    dayDiv.classList.add('today');
                }
                
                // Add day number
                const dayNumber = document.createElement('div');
                dayNumber.className = 'calendar-day-number';
                dayNumber.textContent = date.getDate();
                dayDiv.appendChild(dayNumber);
                
                // Add leave blocks for this day
                const dateStr = formatDate(date);
                const dayLeaves = getLeaveForDate(dateStr);
                dayLeaves.forEach(leave => {
                    const leaveBlock = createLeaveBlock(leave);
                    dayDiv.appendChild(leaveBlock);
                });
                
                calendar.appendChild(dayDiv);
            }
        }
        
        // Get leave for specific date
        function getLeaveForDate(dateStr) {
            return leaveData.filter(record => {
                const leave = record.fields;
                return leave['Status'] === 'Approved' &&
                       leave['Start Date'] <= dateStr &&
                       leave['End Date'] >= dateStr;
            });
        }
        
        // Create leave block element
        function createLeaveBlock(leaveRecord) {
            const leave = leaveRecord.fields;
            const employeeId = leave['Employee']?.[0];
            const employeeName = employeeMap[employeeId] || 'Unknown';
            const leaveType = leave['Leave Type'] || 'Leave';
            
            const block = document.createElement('div');
            block.className = `leave-block ${leaveType.toLowerCase().replace(/\s+/g, '-')}`;
            block.textContent = employeeName;
            block.title = `${employeeName}\n${leaveType}\n${leave['Start Date']} to ${leave['End Date']}`;
            
            // Add click handler to show details
            block.onclick = () => {
                alert(`${employeeName} - ${leaveType}\n` +
                      `From: ${leave['Start Date']}\n` +
                      `To: ${leave['End Date']}\n` +
                      `Notes: ${leave['Notes'] || 'No notes'}`);
            };
            
            return block;
        }

        // Load employee data
        async function loadEmployeeData() {
            try {
                // Fetch employees
                const employeeResponse = await fetch(
                    `https://api.airtable.com/v0/${BASE_ID}/${EMPLOYEE_TABLE_ID}?pageSize=100`,
                    {
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`
                        }
                    }
                );

                if (!employeeResponse.ok) throw new Error('Failed to fetch employees');
                const employeeResult = await employeeResponse.json();
                employeeData = employeeResult.records || [];
                
                // Build employee map for calendar
                employeeMap = {};
                employeeData.forEach(emp => {
                    if (emp.id && emp.fields['Name']) {
                        employeeMap[emp.id] = emp.fields['Name'];
                    }
                });

                // Fetch availability submissions for current week
                const weekStartStr = formatDate(currentWeekStart);
                // Use a simpler approach - fetch all recent submissions then filter client-side
                const availabilityResponse = await fetch(
                    `https://api.airtable.com/v0/${BASE_ID}/${AVAILABILITY_TABLE_ID}?` +
                    `sort[0][field]=Week Starting&sort[0][direction]=desc&pageSize=100`,
                    {
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`
                        }
                    }
                );

                if (availabilityResponse.ok) {
                    const availabilityResult = await availabilityResponse.json();
                    const allSubmissions = availabilityResult.records || [];
                    // Filter for current week client-side
                    availabilityData = allSubmissions.filter(record => 
                        record.fields['Week Starting'] === weekStartStr
                    );
                    console.log(`Found ${availabilityData.length} availability submissions for week starting ${weekStartStr}`, availabilityData);
                    console.log('All submissions:', allSubmissions.map(r => ({
                        employee: r.fields['Employee'],
                        weekStarting: r.fields['Week Starting']
                    })));
                }

                // Fetch allocations for current week
                const weekEndDate = new Date(currentWeekStart);
                weekEndDate.setDate(weekEndDate.getDate() + 6);
                const weekEndStr = formatDate(weekEndDate);

                const allocationsResponse = await fetch(
                    `https://api.airtable.com/v0/${BASE_ID}/${ALLOCATIONS_TABLE_ID}?` +
                    `filterByFormula=${encodeURIComponent(`AND({Shift Date}>='${weekStartStr}', {Shift Date}<='${weekEndStr}')`)}&` +
                    `fields[]=Employee&fields[]=Start Time&fields[]=End Time&fields[]=Shift Date&fields[]=Duration&fields[]=Shift Type&` +
                    `pageSize=100`,
                    {
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`
                        }
                    }
                );

                if (allocationsResponse.ok) {
                    const allocationsResult = await allocationsResponse.json();
                    allocationsData = allocationsResult.records || [];
                    console.log(`Loaded ${allocationsData.length} allocations for week starting ${weekStartStr}`);
                }

                // Load leave data
                await loadLeaveData();

                renderEmployeeList();
                renderMonthlyCalendar();
            } catch (error) {
                console.error('Error loading employee data:', error);
                document.getElementById('employeeList').innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; color: red;">
                            Error loading employee data. Please refresh.
                        </td>
                    </tr>
                `;
            }
        }

        // Calculate hours for employee
        function calculateHoursForWeek(employeeId) {
            const employeeAllocations = allocationsData.filter(a => 
                a.fields['Employee'] && a.fields['Employee'][0] === employeeId
            );

            let totalMinutes = 0;
            employeeAllocations.forEach(allocation => {
                const startTime = allocation.fields['Start Time'];
                const endTime = allocation.fields['End Time'];
                
                if (startTime && endTime) {
                    try {
                        // Parse hours and minutes from time strings
                        const [startHour, startMin] = startTime.split(':').map(Number);
                        const [endHour, endMin] = endTime.split(':').map(Number);
                        
                        // Calculate duration in minutes
                        const startTotalMinutes = startHour * 60 + (startMin || 0);
                        const endTotalMinutes = endHour * 60 + (endMin || 0);
                        let durationMinutes = endTotalMinutes - startTotalMinutes;
                        
                        // Handle overnight shifts (if end time is before start time)
                        if (durationMinutes < 0) {
                            durationMinutes += 24 * 60; // Add 24 hours
                        }
                        
                        totalMinutes += durationMinutes;
                    } catch (error) {
                        console.error('Error calculating duration for allocation:', {
                            startTime,
                            endTime,
                            shiftDate: allocation.fields['Shift Date'],
                            error: error.message
                        });
                    }
                } else {
                    // Log allocations missing time data
                    if (allocation.fields['Shift Date']) {
                        console.warn('Allocation missing time data:', {
                            shiftDate: allocation.fields['Shift Date'],
                            startTime: startTime || 'missing',
                            endTime: endTime || 'missing',
                            employeeId
                        });
                    }
                }
            });

            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            if (totalMinutes === 0) {
                return '0h';
            }
            return minutes > 0 ? `${hours}h ${minutes}m` : `${hours}h`;
        }

        // Get availability status
        function getAvailabilityStatus(employeeId) {
            const submission = availabilityData.find(a => 
                a.fields['Employee'] && a.fields['Employee'][0] === employeeId
            );

            if (!submission) {
                return { status: 'not-submitted', text: 'Not Submitted' };
            }

            const processingStatus = submission.fields['Processing Status'];
            console.log(`Processing status for employee ${employeeId}:`, processingStatus);
            
            if (processingStatus === 'Processed') {
                return { status: 'submitted', text: 'Submitted' };
            } else {
                return { status: 'pending', text: 'Pending' };
            }
        }

        // Render employee list
        function renderEmployeeList() {
            const tbody = document.getElementById('employeeList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const activeOnly = document.getElementById('activeOnly').checked;
            const pendingOnly = document.getElementById('pendingOnly').checked;

            let filteredEmployees = employeeData.filter(employee => {
                const fields = employee.fields;
                
                // Search filter
                if (searchTerm) {
                    const name = (fields['Name'] || '').toLowerCase();
                    const email = (fields['Email'] || '').toLowerCase();
                    if (!name.includes(searchTerm) && !email.includes(searchTerm)) {
                        return false;
                    }
                }

                // Active roster filter
                if (activeOnly && !fields['Active Roster']) {
                    return false;
                }

                // Pending availability filter
                if (pendingOnly) {
                    const status = getAvailabilityStatus(employee.id);
                    if (status.status === 'submitted') {
                        return false;
                    }
                }

                return true;
            });

            if (filteredEmployees.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; color: #666;">
                            No employees found matching your criteria.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredEmployees.map(employee => {
                const fields = employee.fields;
                const hours = calculateHoursForWeek(employee.id);
                const availabilityStatus = getAvailabilityStatus(employee.id);
                const leaveStatus = getLeaveStatus(employee.id);
                const staffType = fields['Staff Type'] || 'Casual';
                const isFullTime = staffType === 'Full Time';
                
                // Debug logging for Max Mckelvey
                if (fields['Name'] && fields['Name'].toLowerCase().includes('max')) {
                    console.log('Max Mckelvey debug:', {
                        employeeId: employee.id,
                        name: fields['Name'],
                        staffType: staffType,
                        availabilityStatus: availabilityStatus,
                        weekStart: formatDate(currentWeekStart),
                        availableSubmissions: availabilityData.map(a => ({
                            employeeId: a.fields['Employee']?.[0],
                            weekStarting: a.fields['Week Starting'],
                            status: a.fields['Processing Status']
                        }))
                    });
                }

                let leaveDisplay = '-';
                if (leaveStatus.onLeave) {
                    const endDate = new Date(leaveStatus.endDate);
                    const endDateStr = endDate.toLocaleDateString('en-AU', { month: 'short', day: 'numeric' });
                    leaveDisplay = `<span style="color: #dc3545; font-weight: 500;">
                        <i class="fas fa-plane"></i> ${leaveStatus.type} until ${endDateStr}
                    </span>`;
                }

                const staffTypeClass = isFullTime ? 'full-time' : 'casual';
                const staffTypeBadge = `<span class="staff-type-badge ${staffTypeClass}">${staffType}</span>`;

                return `
                    <tr ${leaveStatus.onLeave ? 'style="background-color: #fff3e0;"' : ''}>
                        <td><strong>${fields['Name'] || 'Unknown'}</strong></td>
                        <td>${fields['Email'] || '-'}</td>
                        <td>${fields['Mobile Number'] || '-'}</td>
                        <td>${staffTypeBadge}</td>
                        <td class="active-roster-cell">
                            <input type="checkbox" 
                                   class="roster-checkbox" 
                                   ${fields['Active Roster'] ? 'checked' : ''}
                                   onchange="toggleActiveRoster('${employee.id}', this.checked)"
                                   title="${fields['Active Roster'] ? 'Remove from active roster' : 'Add to active roster'}">
                        </td>
                        <td class="hours-cell">${hours || '0h'}</td>
                        <td>
                            <span class="availability-status status-${availabilityStatus.status}">
                                ${availabilityStatus.text}
                            </span>
                        </td>
                        <td>${leaveDisplay}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-small" 
                                        onclick="openLeaveModal('${employee.id}', '${fields['Name'] || 'Unknown'}')">
                                    <i class="fas fa-calendar-times"></i> Leave
                                </button>
                                ${isFullTime ? `
                                    <button class="btn btn-secondary btn-small" 
                                            onclick="openFixedAvailabilityModal('${employee.id}', '${fields['Name'] || 'Unknown'}')">
                                        <i class="fas fa-clock"></i> Fixed Hours
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Toggle active roster
        async function toggleActiveRoster(employeeId, isActive) {
            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${BASE_ID}/${EMPLOYEE_TABLE_ID}/${employeeId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fields: {
                                'Active Roster': isActive
                            }
                        })
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to update active roster status');
                }

                // Update local data
                const employee = employeeData.find(e => e.id === employeeId);
                if (employee) {
                    employee.fields['Active Roster'] = isActive;
                }

                // Show success message
                alert(`Employee ${isActive ? 'added to' : 'removed from'} active roster`);
            } catch (error) {
                console.error('Error updating active roster:', error);
                alert('Failed to update active roster status. Please try again.');
                // Revert checkbox
                renderEmployeeList();
            }
        }

        // Open leave modal
        function openLeaveModal(employeeId, employeeName) {
            document.getElementById('leaveEmployeeId').value = employeeId;
            document.getElementById('leaveEmployeeName').value = employeeName;
            document.getElementById('leaveEmployeeDisplay').value = employeeName;
            
            // Set default dates to today
            const today = new Date();
            today.setFullYear(2025);
            document.getElementById('leaveStartDate').value = formatDate(today);
            document.getElementById('leaveEndDate').value = formatDate(today);
            
            document.getElementById('leaveModal').classList.add('active');
        }

        // Close leave modal
        function closeLeaveModal() {
            document.getElementById('leaveModal').classList.remove('active');
            document.getElementById('leaveForm').reset();
        }

        // Handle leave form submission
        document.getElementById('leaveForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const employeeId = document.getElementById('leaveEmployeeId').value;
            const employeeName = document.getElementById('leaveEmployeeName').value;
            const leaveType = document.getElementById('leaveType').value;
            const startDate = document.getElementById('leaveStartDate').value;
            const endDate = document.getElementById('leaveEndDate').value;
            const notes = document.getElementById('leaveNotes').value;

            try {
                // Get current user for submitted by field
                const { data: { user } } = await supabase.auth.getUser();
                
                // Create leave record in Airtable
                const response = await fetch(
                    `https://api.airtable.com/v0/${BASE_ID}/${LEAVE_TABLE_ID}`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fields: {
                                'Leave ID': `LEAVE-${Date.now()}`,
                                'Employee': [employeeId],
                                'Leave Type': leaveType,
                                'Start Date': startDate,
                                'End Date': endDate,
                                'Notes': notes || '',
                                'Status': 'Approved', // Auto-approve for now
                                'Submitted Date': formatDate(new Date()),
                                'Submitted By': user?.email || 'Management'
                            }
                        })
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to create leave record');
                }

                const newRecord = await response.json();
                console.log('Leave created:', newRecord);
                
                // Add to local data
                leaveData.push(newRecord);
                
                // Show success message
                alert(`Leave successfully recorded for ${employeeName}\n${leaveType}: ${startDate} to ${endDate}`);
                
                closeLeaveModal();
                
                // Refresh the employee list and calendar to show the new leave
                renderEmployeeList();
                renderMonthlyCalendar();
            } catch (error) {
                console.error('Error creating leave:', error);
                alert('Failed to create leave record. Please try again.');
            }
        });

        // Open fixed availability modal
        async function openFixedAvailabilityModal(employeeId, employeeName) {
            document.getElementById('fixedEmployeeId').value = employeeId;
            document.getElementById('fixedEmployeeDisplay').value = employeeName;
            
            // Find employee data
            const employee = employeeData.find(e => e.id === employeeId);
            const fields = employee?.fields || {};
            
            // Generate days HTML
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const container = document.getElementById('fixedDaysContainer');
            
            container.innerHTML = days.map(day => {
                const isFixed = fields[`Fixed ${day}`] || false;
                const startTime = fields[`Fixed ${day} Start`] || '9:00 AM';
                const endTime = fields[`Fixed ${day} End`] || '5:00 PM';
                
                return `
                    <div class="day-schedule">
                        <div class="day-checkbox">
                            <input type="checkbox" 
                                   id="fixed-${day}" 
                                   name="fixed-${day}"
                                   ${isFixed ? 'checked' : ''}
                                   onchange="toggleDayInputs('${day}', this.checked)">
                            <label for="fixed-${day}">${day}</label>
                        </div>
                        <div class="time-inputs">
                            <input type="text" 
                                   id="fixed-${day}-start" 
                                   placeholder="Start time"
                                   value="${startTime}"
                                   ${!isFixed ? 'disabled' : ''}>
                            <span>to</span>
                            <input type="text" 
                                   id="fixed-${day}-end" 
                                   placeholder="End time"
                                   value="${endTime}"
                                   ${!isFixed ? 'disabled' : ''}>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('fixedAvailabilityModal').classList.add('active');
        }
        
        // Close fixed availability modal
        function closeFixedAvailabilityModal() {
            document.getElementById('fixedAvailabilityModal').classList.remove('active');
        }
        
        // Toggle day inputs
        function toggleDayInputs(day, enabled) {
            const startInput = document.getElementById(`fixed-${day}-start`);
            const endInput = document.getElementById(`fixed-${day}-end`);
            
            startInput.disabled = !enabled;
            endInput.disabled = !enabled;
            
            if (!enabled) {
                startInput.value = '9:00 AM';
                endInput.value = '5:00 PM';
            }
        }
        
        // Handle fixed availability form submission
        document.getElementById('fixedAvailabilityForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const employeeId = document.getElementById('fixedEmployeeId').value;
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            // Build update fields
            const updateFields = {};
            
            days.forEach(day => {
                const checkbox = document.getElementById(`fixed-${day}`);
                const startInput = document.getElementById(`fixed-${day}-start`);
                const endInput = document.getElementById(`fixed-${day}-end`);
                
                updateFields[`Fixed ${day}`] = checkbox.checked;
                updateFields[`Fixed ${day} Start`] = startInput.value || '9:00 AM';
                updateFields[`Fixed ${day} End`] = endInput.value || '5:00 PM';
            });
            
            try {
                // Update in Airtable
                const response = await fetch(
                    `https://api.airtable.com/v0/${BASE_ID}/${EMPLOYEE_TABLE_ID}/${employeeId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fields: updateFields
                        })
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to update fixed availability');
                }

                // Update local data
                const employee = employeeData.find(e => e.id === employeeId);
                if (employee) {
                    Object.assign(employee.fields, updateFields);
                }

                // Show success message
                alert('Fixed availability updated successfully!');
                closeFixedAvailabilityModal();
                renderEmployeeList();
            } catch (error) {
                console.error('Error updating fixed availability:', error);
                alert('Failed to update fixed availability. Please try again.');
            }
        });

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', renderEmployeeList);
        document.getElementById('activeOnly').addEventListener('change', renderEmployeeList);
        document.getElementById('pendingOnly').addEventListener('change', renderEmployeeList);

        // Logout function
        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'auth.html';
        }

        // Initialize on page load
        checkAuth();
    </script>
</body>
</html>
