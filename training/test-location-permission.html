<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Permission Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin: 20px 0;
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .debug-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Location Permission Test</h1>
    
    <div class="status info">
        <h3>Quick Checks:</h3>
        <p><strong>Current URL:</strong> <span id="currentUrl"></span></p>
        <p><strong>Protocol:</strong> <span id="protocol"></span></p>
        <p><strong>Geolocation API Available:</strong> <span id="geoAvailable"></span></p>
    </div>
    
    <button class="test-button" onclick="testLocation()">Test Location Access</button>
    
    <div id="results"></div>
    
    <h3>Troubleshooting Steps:</h3>
    <ol>
        <li><strong>Check URL:</strong> Must be HTTPS (not HTTP)</li>
        <li><strong>Device Settings:</strong> Location Services must be ON</li>
        <li><strong>Browser Permission:</strong> Must be allowed for this site</li>
        <li><strong>Try Different Browser:</strong> Safari, Chrome, or Firefox</li>
    </ol>

    <script>
        // Display current environment info
        document.getElementById('currentUrl').textContent = window.location.href;
        document.getElementById('protocol').textContent = window.location.protocol;
        document.getElementById('geoAvailable').textContent = 
            'geolocation' in navigator ? 'Yes ✓' : 'No ✗';
        
        async function testLocation() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            // Check if geolocation is available
            if (!navigator.geolocation) {
                resultsDiv.innerHTML = `
                    <div class="status error">
                        <h3>Geolocation Not Supported</h3>
                        <p>Your browser doesn't support geolocation.</p>
                    </div>
                `;
                return;
            }
            
            // Check if we're on HTTPS
            if (window.location.protocol !== 'https:' && 
                window.location.hostname !== 'localhost' && 
                window.location.hostname !== '127.0.0.1') {
                resultsDiv.innerHTML += `
                    <div class="status error">
                        <h3>HTTPS Required</h3>
                        <p>Location services only work on HTTPS sites.</p>
                        <p>Current protocol: ${window.location.protocol}</p>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML += `
                <div class="status info">
                    <h3>Requesting Location...</h3>
                    <p>You may see a permission prompt. Please click "Allow".</p>
                </div>
            `;
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        resolve,
                        reject,
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                });
                
                resultsDiv.innerHTML = `
                    <div class="status success">
                        <h3>✓ Location Access Working!</h3>
                        <p><strong>Latitude:</strong> ${position.coords.latitude.toFixed(6)}</p>
                        <p><strong>Longitude:</strong> ${position.coords.longitude.toFixed(6)}</p>
                        <p><strong>Accuracy:</strong> ±${Math.round(position.coords.accuracy)}m</p>
                    </div>
                    <div class="debug-info">
                        <strong>Debug Info:</strong><br>
                        Timestamp: ${new Date(position.timestamp).toLocaleString()}<br>
                        Altitude: ${position.coords.altitude || 'N/A'}<br>
                        Speed: ${position.coords.speed || 'N/A'}
                    </div>
                `;
                
            } catch (error) {
                let errorMessage = 'Unknown error';
                let solution = '';
                
                switch(error.code) {
                    case 1: // PERMISSION_DENIED
                        errorMessage = 'Permission Denied';
                        solution = `
                            <h4>Solutions:</h4>
                            <ul>
                                <li>Check browser settings for this site</li>
                                <li>Clear site data and try again</li>
                                <li>Check device Location Services are ON</li>
                                <li>For iOS: Settings > Privacy > Location Services</li>
                                <li>For Android: Settings > Location</li>
                            </ul>
                        `;
                        break;
                    case 2: // POSITION_UNAVAILABLE
                        errorMessage = 'Position Unavailable';
                        solution = `
                            <h4>Solutions:</h4>
                            <ul>
                                <li>Check device has GPS/Location enabled</li>
                                <li>Try moving to area with better signal</li>
                                <li>Restart browser and try again</li>
                            </ul>
                        `;
                        break;
                    case 3: // TIMEOUT
                        errorMessage = 'Location Request Timed Out';
                        solution = `
                            <h4>Solutions:</h4>
                            <ul>
                                <li>Check internet connection</li>
                                <li>Try again in area with better GPS signal</li>
                                <li>Close other apps using location</li>
                            </ul>
                        `;
                        break;
                }
                
                resultsDiv.innerHTML = `
                    <div class="status error">
                        <h3>✗ Location Access Failed</h3>
                        <p><strong>Error:</strong> ${errorMessage}</p>
                        <p><strong>Error Code:</strong> ${error.code}</p>
                        <p><strong>Message:</strong> ${error.message}</p>
                        ${solution}
                    </div>
                    <div class="debug-info">
                        <strong>Full Error:</strong><br>
                        ${JSON.stringify(error, null, 2)}
                    </div>
                `;
            }
        }
        
        // Auto-test on load if on HTTPS
        if (window.location.protocol === 'https:' || 
            window.location.hostname === 'localhost') {
            // Don't auto-test, let user click
        }
    </script>
</body>
</html>
