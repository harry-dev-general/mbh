<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Management Dashboard - MBH Staff Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/role-helper.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Maps API will be loaded dynamically -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f6fa;
            color: #2c3e50;
            line-height: 1.6;
            overflow-x: hidden;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        
        /* Main Layout */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
            position: relative;
            max-width: 100vw;
            overflow-x: hidden;
        }
        
        .dashboard-layout {
            display: flex;
            flex: 1;
            position: relative;
        }
        
        /* Left Sidebar Navigation */
        .sidebar-nav {
            width: 240px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            padding: 0;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .logo-section {
            text-align: center;
            padding: 2rem 1.5rem;
            border-bottom: 1px solid #e0e6ed;
            margin-bottom: 2rem;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 1rem;
        }
        
        .logo {
            height: 50px;
            margin-bottom: 0.5rem;
        }
        
        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1B4F72;
        }
        
        /* View Toggle */
        .view-toggle {
            margin: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #64748b;
        }
        
        .toggle-switch {
            width: 50px;
            height: 24px;
            background: #e0e6ed;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .toggle-switch.management {
            background: #1B4F72;
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .toggle-switch.management .toggle-slider {
            transform: translateX(26px);
        }
        
        .nav-items {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .nav-item {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
            color: #64748b;
        }
        
        .nav-item:hover {
            background: #f8f9fa;
            color: #1B4F72;
        }
        
        .nav-item.active {
            background: #e6f2f8;
            color: #1B4F72;
            border-right: 3px solid #1B4F72;
        }
        
        .nav-item i {
            width: 20px;
            text-align: center;
        }
        
        /* Main Content Area */
        .main-content {
            flex: 1;
            padding: 2rem;
            max-width: 1200px;
            margin-left: 0;
            position: relative;
            z-index: 1;
            width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .greeting h1 {
            font-size: 2rem;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }
        
        .greeting p {
            color: #64748b;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        /* Calendar Section */
        .calendar-section {
            background: white;
            border-radius: 16px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            margin-bottom: 1rem;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .view-all-btn {
            color: #3b82f6;
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .view-all-btn:hover {
            color: #2563eb;
            text-decoration: underline;
        }
        
        .calendar-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .calendar-nav-btn {
            width: 36px;
            height: 36px;
            border: 1px solid #e0e6ed;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #64748b;
        }
        
        .calendar-nav-btn:hover {
            background: #f8f9fa;
            color: #3b82f6;
            border-color: #3b82f6;
        }
        
        .current-week-display {
            font-weight: 600;
            color: #1e293b;
            min-width: 200px;
            text-align: center;
        }
        
        .weekly-calendar {
            position: relative;
        }
        
        /* List View Calendar Styles */
        .calendar-list-view {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .calendar-day-group {
            border-bottom: 1px solid #e0e6ed;
        }
        
        .calendar-day-group:last-child {
            border-bottom: none;
        }
        
        .calendar-day-header {
            background: #f8f9fa;
            padding: 0.75rem 1rem;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .calendar-day-header.today {
            background: #e6f2f8;
            color: #1B4F72;
        }
        
        .calendar-day-date {
            font-size: 0.875rem;
            color: #64748b;
        }
        
        .calendar-bookings-list {
            padding: 0.5rem;
        }
        
        .calendar-booking-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .calendar-booking-item:hover {
            background: #e6f2f8;
            transform: translateX(4px);
        }
        
        .calendar-booking-time {
            font-weight: 600;
            color: #1B4F72;
            font-size: 0.875rem;
            min-width: 80px;
        }
        
        .calendar-booking-details {
            flex: 1;
            margin-left: 1rem;
        }
        
        .calendar-booking-vessel {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.875rem;
        }
        
        .calendar-booking-customer {
            color: #64748b;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        
        .calendar-booking-addon {
            background: #fbbf24;
            color: #78350f;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .calendar-booking-addon i {
            font-size: 0.65rem;
        }
        
        .calendar-no-bookings {
            padding: 1rem;
            text-align: center;
            color: #94a3b8;
            font-size: 0.875rem;
        }
        
        /* Custom scrollbar for list view */
        .calendar-list-view::-webkit-scrollbar {
            width: 6px;
        }
        
        .calendar-list-view::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        .calendar-list-view::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .calendar-list-view::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .calendar-loading {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            color: #94a3b8;
            padding: 3rem;
        }
        
        .calendar-loading i {
            font-size: 2rem;
        }
        
        .time-label {
            padding: 0.4rem 0.3rem;
            text-align: right;
            font-size: 0.7rem;
            color: #64748b;
            background: #f8f9fa;
            border-right: 1px solid #e0e6ed;
            border-bottom: 1px solid #f1f5f9;
            position: sticky;
            left: 0;
            z-index: 1;
        }
        
        .day-header {
            padding: 0.6rem 0.4rem;
            text-align: center;
            font-weight: 600;
            background: #f8f9fa;
            border-right: 1px solid #e0e6ed;
            border-bottom: 2px solid #e0e6ed;
            color: #475569;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        
        .day-header.today {
            background: #e0f2fe;
            color: #0284c7;
            position: sticky;
            top: 0;
        }
        
        .day-header .day-name {
            font-size: 0.75rem;
            margin-bottom: 0.125rem;
        }
        
        .day-header .day-date {
            font-size: 0.65rem;
            opacity: 0.8;
        }
        
        .day-cell {
            border-right: 1px solid #f1f5f9;
            border-bottom: 1px solid #f1f5f9;
            padding: 0.3rem;
            position: relative;
            min-height: 35px;
            background: white;
            transition: background 0.2s ease;
        }
        
        .day-cell:hover {
            background: #f8f9fa;
        }
        
        .day-cell.today {
            background: #f0f9ff;
        }
        
        .day-cell.today:hover {
            background: #e0f2fe;
        }
        
        .calendar-event {
            background: #e0f2fe;
            border-left: 2px solid #3b82f6;
            border-radius: 4px;
            padding: 0.25rem 0.3rem;
            margin-bottom: 0.15rem;
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.2s ease;
            line-height: 1.2;
        }
        
        .calendar-event:hover {
            transform: translateX(1px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .calendar-event.booking {
            background: #fef3c7;
            border-left-color: #f59e0b;
        }
        
        .calendar-event.maintenance {
            background: #fce7f3;
            border-left-color: #ec4899;
        }
        
        .event-time {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.6rem;
        }
        
        .event-details {
            color: #64748b;
            margin-top: 0.05rem;
            font-size: 0.6rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Fleet Section */
        .fleet-section {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            margin-bottom: 2rem;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        .fleet-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 1.5rem;
            height: 450px;
        }
        
        .vessels-list {
            overflow-y: auto;
            padding-right: 0.5rem;
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 12px;
            max-height: 450px;
        }
        
        /* Custom scrollbar for vessels list */
        .vessels-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .vessels-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .vessels-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        .vessels-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Vessel Card Styles - Compact Design */
        .vessel-card {
            background: white;
            border-radius: 8px;
            padding: 0.75rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            transition: all 0.2s;
            margin-bottom: 0.5rem;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        .vessel-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }
        
        .vessel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .vessel-name {
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            color: #333;
        }
        
        .vessel-name i {
            font-size: 0.85rem;
        }
        
        .vessel-location {
            display: flex;
            align-items: center;
            gap: 0.2rem;
            color: #666;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .vessel-location i {
            font-size: 0.7rem;
        }
        
        .status-badge {
            padding: 0.15rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            background: #D4EDDA;
            color: #155724;
        }
        
        .status-badge.maintenance {
            background: #FFF3CD;
            color: #856404;
        }
        
        .status-badge.unavailable {
            background: #F8D7DA;
            color: #721C24;
        }
        
        /* Resource Gauges - Compact */
        .resource-gauges {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.4rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e0e0e0;
        }
        
        .gauge {
            text-align: center;
        }
        
        .gauge-label {
            font-size: 0.65rem;
            color: #666;
            margin-bottom: 0.15rem;
            text-transform: uppercase;
            font-weight: 500;
        }
        
        .gauge-bar {
            height: 5px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }
        
        .gauge-fill {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s;
        }
        
        .gauge-fill.low {
            background: #f44336;
        }
        
        .gauge-fill.medium {
            background: #FF9800;
        }
        
        .gauge-value {
            font-size: 0.7rem;
            margin-top: 0.15rem;
            font-weight: 600;
        }
        
        /* Vessel Maintenance Tab Styles */
        .vessel-maintenance-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        
        .vessel-maintenance-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .vessel-maintenance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .vessel-maintenance-header h3 {
            margin: 0;
            font-size: 1.2rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .vessel-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .vessel-status.status-ready {
            background: #D4EDDA;
            color: #155724;
        }
        
        .vessel-status.status-attention {
            background: #FFF3CD;
            color: #856404;
        }
        
        .vessel-status.status-unavailable {
            background: #F8D7DA;
            color: #721C24;
        }
        
        .vessel-maintenance-details {
            margin-bottom: 1.5rem;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
        }
        
        .detail-item:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: #666;
            font-weight: 500;
        }
        
        .detail-value {
            color: #333;
        }
        
        .vessel-maintenance-actions {
            display: flex;
            gap: 0.75rem;
        }
        
        .action-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #64748b;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #475569;
            transform: translateY(-1px);
        }
        
        .stat-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            background: white;
            color: #64748b;
        }
        
        #fleetMap {
            border-radius: 12px;
            overflow: hidden;
        }
        
        /* Right Sidebar */
        .right-sidebar {
            width: 360px;
            padding: 2rem;
            flex-shrink: 0;
        }
        
        /* Upcoming Bookings */
        .sidebar-section {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            margin-bottom: 1.5rem;
        }
        
        .new-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: #10b981;
        }
        
        .new-indicator i {
            font-size: 0.5rem;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .booking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.3s ease;
        }
        
        .booking-item:last-child {
            border-bottom: none;
        }
        
        .booking-item.new-booking:first-child {
            position: relative;
        }
        
        .booking-item.new-booking:first-child::before {
            content: '';
            position: absolute;
            left: -1rem;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #10b981;
            border-radius: 2px;
        }
        
        .booking-details h4 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .booking-details p {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.125rem;
        }
        
        .booking-time {
            font-size: 0.65rem;
            color: #94a3b8;
            font-style: italic;
        }
        
        .booking-stats {
            text-align: right;
            flex-shrink: 0;
        }
        
        .booking-value {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .booking-label {
            font-size: 0.75rem;
            color: #94a3b8;
        }
        
        /* Staff Availability */
        .availability-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .time-toggle {
            display: flex;
            gap: 0.5rem;
            font-size: 0.75rem;
        }
        
        .time-toggle span {
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            color: #64748b;
        }
        
        .time-toggle span.active {
            background: #e0f2fe;
            color: #0284c7;
            font-weight: 500;
        }
        
        .availability-chart {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 120px;
            margin-top: 1rem;
        }
        
        .day-bar {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        
        .bar {
            width: 100%;
            background: #e0f2fe;
            border-radius: 8px 8px 0 0;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .bar:hover {
            background: #bae6fd;
        }
        
        .bar.high {
            height: 100px;
            background: #3b82f6;
        }
        
        .bar.medium {
            height: 70px;
            background: #60a5fa;
        }
        
        .bar.low {
            height: 40px;
        }
        
        .staff-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            border: 2px solid white;
        }
        
        .day-label {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
        }
        
        /* New Staff Availability Grid */
        .staff-availability-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
            margin-top: 1rem;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 0.5rem;
            max-width: 100%;
        }
        
        /* Custom scrollbar for staff availability */
        .staff-availability-grid::-webkit-scrollbar {
            height: 4px;
        }
        
        .staff-availability-grid::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 2px;
        }
        
        .staff-availability-grid::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }
        
        .staff-availability-grid::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .day-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            min-width: 36px;
        }
        
        .day-column .day-label {
            font-size: 0.7rem;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 0.15rem;
            text-align: center;
            padding: 0.15rem 0.25rem;
            border-radius: 4px;
        }
        
        .day-column .day-label.today {
            background: #e0f2fe;
            color: #0284c7;
            font-weight: 700;
        }
        
        .staff-initials-container {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            align-items: center;
            min-height: 80px;
        }
        
        .staff-initial-circle {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: #e0f2fe;
            color: #0284c7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 600;
            border: 1.5px solid white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            flex-shrink: 0;
        }
        
        .staff-initial-circle:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        
        .staff-initial-circle.full-time {
            background: #d1fae5;
            color: #065f46;
        }
        
        .staff-initial-circle.casual {
            background: #fef3c7;
            color: #92400e;
        }
        
        .no-staff {
            font-size: 0.7rem;
            color: #cbd5e1;
            font-style: italic;
            height: 28px;
            display: flex;
            align-items: center;
        }
        
        /* User Menu */
        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #1B4F72;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .user-info {
            text-align: right;
        }
        
        .user-name {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.125rem;
        }
        
        .user-role {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Quick Action Cards Hover */
        .quick-action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.08) !important;
        }
        
        /* Responsive */
        @media (max-width: 1440px) {
            .dashboard-layout {
                flex-direction: column;
            }
            
            .main-content {
                margin-right: 0;
                margin-bottom: 2rem;
            }
            
            .right-sidebar {
            width: 100%;
                max-width: 600px;
                margin: 0 auto;
                padding: 0 2rem 2rem;
            }
        }
        
        @media (max-width: 1024px) {
            .sidebar-nav {
                display: none;
            }
            
            .logout-container {
                display: none;
            }
            
            .main-content {
                padding: 1rem;
                margin-left: 0;
            }
            
            .right-sidebar {
                padding: 0 1rem 2rem;
            }
            
            .fleet-container {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .vessels-list {
                height: 250px;
                max-height: 250px;
            }
            
            .calendar-section {
                overflow: hidden;
                padding: 1rem;
            }
            
            .calendar-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -1rem;
                padding: 0 1rem;
            }
            
            .calendar-list-view {
                min-width: 100%;
                width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-container {
                min-height: 100vh;
                overflow-x: hidden;
            }
            
            .header {
                padding: 1rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .greeting {
                width: 100%;
            }
            
            .header h1 {
                font-size: 1.5rem;
                word-wrap: break-word;
            }
            
            .header-actions {
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
            }
            
            .user-menu {
                gap: 0.5rem;
                font-size: 0.875rem;
                flex-wrap: wrap;
            }
            
            #userEmail {
                max-width: 150px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            .main-content {
                padding: 1rem;
                width: 100%;
                overflow-x: hidden;
            }
            
            .section-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .sidebar-section {
                margin-bottom: 1rem;
                padding: 1rem;
            }
            
            .booking-item {
                padding: 1rem;
            }
            
            .time-slot {
                font-size: 0.75rem;
                padding: 0.5rem;
            }
            
            .vessel-header h4 {
                font-size: 0.875rem;
            }
            
            .vessel-status {
                font-size: 0.75rem;
            }
            
            /* Quick Actions Mobile Fix */
            .quick-actions-section {
                width: 100%;
                padding: 0;
            }
            
            .quick-actions-section > div {
                grid-template-columns: 1fr !important;
                gap: 0.75rem !important;
                width: 100%;
            }
            
            .quick-action-card {
                width: 100%;
                padding: 1rem !important;
                overflow: hidden;
                box-sizing: border-box;
            }
            
            .quick-action-card > div {
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
            }
            
            .quick-action-card i {
                flex-shrink: 0;
            }
            
            .quick-action-card span {
                font-size: 0.95rem !important;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                display: block;
            }
            
            /* Fleet Section Mobile Fix */
            .fleet-section {
                padding: 1rem !important;
                overflow: hidden;
            }
            
            .vessels-list {
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .vessel-card {
                width: 100%;
                overflow: hidden;
                box-sizing: border-box;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 0.75rem;
            }
            
            .header h1 {
                font-size: 1.25rem;
            }
            
            .greeting p {
                font-size: 0.875rem;
            }
            
            .header-actions button,
            .header-actions a {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            
            .main-content {
                padding: 0.75rem;
            }
            
            .toggle-switch {
                transform: scale(0.9);
            }
            
            /* List view mobile optimization */
            .calendar-list-view {
                max-height: 350px !important;
            }
            
            .calendar-day-header {
                padding: 0.5rem !important;
                font-size: 0.875rem !important;
            }
            
            .calendar-booking-item {
                padding: 0.5rem !important;
            }
            
            .calendar-section {
                padding: 0.5rem !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            
            .calendar-container {
                width: 100% !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            /* Make calendar cells smaller on mobile */
            .hour-cell {
                min-height: 30px !important;
                padding: 0.1rem !important;
            }
            
            .time-slot {
                font-size: 0.6rem !important;
                padding: 0.1rem !important;
            }
            
            .day-header {
                padding: 0.25rem !important;
                font-size: 0.65rem !important;
            }
            
            .time-labels {
                display: none;
            }
            
            .booking-slot {
                font-size: 0.7rem;
                padding: 0.25rem;
            }
            
            .availability-chart {
                display: none;
            }
            
            .staff-availability-grid {
                gap: 0.2rem;
                font-size: 0.9rem;
            }
            
            .staff-initial-circle {
                width: 22px;
                height: 22px;
                font-size: 0.55rem;
                border-width: 1px;
            }
            
            .day-column {
                min-width: 32px;
            }
            
            .day-column .day-label {
                font-size: 0.6rem;
                padding: 0.1rem 0.2rem;
            }
            
            .time-toggle {
                font-size: 0.75rem;
            }
            
            .new-indicator {
                font-size: 0.75rem;
            }
            
            /* Section spacing on mobile */
            .quick-actions-section,
            .calendar-section,
            .fleet-section {
                margin-bottom: 1rem !important;
                border-radius: 12px;
                width: 100%;
                box-sizing: border-box;
            }
            
            .section-title {
                font-size: 1.1rem;
                margin-bottom: 1rem !important;
            }
            
            /* Quick Actions Mobile Overrides */
            .quick-action-card {
                padding: 1rem !important;
                min-height: 60px !important; /* Touch-friendly size */
                display: flex !important;
                align-items: center !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            
            .quick-action-card > div {
                width: 100% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }
            
            .quick-action-card i {
                font-size: 1.25rem !important;
                margin-right: 0.5rem !important;
            }
            
            .quick-action-card span {
                font-size: 0.9rem !important;
                white-space: nowrap !important;
            }
            
            /* Prevent any horizontal overflow */
            body,
            .dashboard-container,
            .main-content {
                max-width: 100%;
                overflow-x: hidden;
            }
            
            /* Fleet cards mobile fix */
            .vessel-card {
                padding: 0.75rem !important;
                margin-bottom: 0.75rem;
            }
            
            .vessel-header h4 {
                font-size: 0.9rem !important;
            }
            
            .resource-gauges {
                transform: scale(0.85);
                transform-origin: left center;
            }
        }
        
        /* Quick Action Card Hover Effect */
        .quick-action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12) !important;
        }
        
        /* Submit Button Hover Effect */
        .btn-submit:hover {
            background: #2E86AB !important;
        }
        
        /* Announcement Styles */
        .announcement-item {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .announcement-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .announcement-header h4 {
            margin: 0;
            color: #333;
            font-size: 1.1rem;
        }
        
        .announcement-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #666;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e0e6ed;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .text-muted {
            color: #6c757d;
            text-align: center;
            padding: 2rem;
        }
        
        /* Mobile Menu */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: #475569;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            margin-right: 1rem;
            transition: color 0.3s ease;
        }
        
        .mobile-menu-btn:hover {
            color: #1B4F72;
        }
        
        @media (max-width: 1024px) {
            .mobile-menu-btn {
                display: block;
            }
            
            .sidebar-nav.mobile-open {
                display: flex;
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1000;
                box-shadow: 0 0 30px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease-out;
            }
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(-100%);
            }
            to {
                transform: translateX(0);
            }
        }
        
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            backdrop-filter: blur(2px);
        }
        
        .mobile-overlay.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Mobile-First Responsive Design */
        /* Base styles for all screen sizes */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            width: 100%;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Tablet and up */
        @media (min-width: 768px) {
            .quick-actions-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Desktop and up */
        @media (min-width: 1024px) {
            .quick-actions-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* Global Mobile Reset and Containment */
        @media (max-width: 768px) {
            /* Reset all elements to prevent overflow */
            * {
                max-width: 100% !important;
            }
            
            /* Ensure html and body don't overflow */
            html, body {
                overflow-x: hidden !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* Main container constraints */
            .dashboard-container {
                width: 100% !important;
                max-width: 100% !important;
                overflow-x: hidden !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .main-content {
                width: 100% !important;
                max-width: 100% !important;
                padding: 0.5rem !important;
                margin: 0 !important;
                overflow-x: hidden !important;
            }
        }
        
        /* Mobile Section Width Constraints */
        @media (max-width: 768px) {
            /* Ensure all sections fit within viewport */
            .quick-actions-section,
            .calendar-section,
            .fleet-section,
            .sidebar-section {
                max-width: 100% !important;
                width: 100% !important;
                box-sizing: border-box !important;
                overflow: hidden !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }
            
            /* Calendar responsiveness */
            .weekly-calendar {
                width: 100%;
                overflow: hidden;
            }
            
            .calendar-container {
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 0.5rem;
            }
            
            /* Calendar list view mobile adjustments */
            .calendar-list-view {
                font-size: 0.875rem;
            }
            
            .calendar-day-header {
                position: sticky;
                top: 0;
                z-index: 10;
                background: #f8f9fa;
            }
            
            .calendar-day-header.today {
                background: #e6f2f8;
            }
            
            .calendar-booking-item {
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }
            
            .calendar-booking-item:active {
                transform: scale(0.98);
                background: #e6f2f8;
            }
            
            /* Fleet responsiveness */
            .fleet-container {
                width: 100%;
                overflow: hidden;
            }
            
            .vessels-list {
                width: 100%;
                padding: 0;
            }
            
            /* Vessel card mobile layout */
            .vessel-card {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .vessel-header {
                width: 100%;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .vessel-name {
                flex: 1;
                min-width: 0;
            }
            
            .vessel-name h4 {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            .vessel-info {
                width: 100%;
            }
            
            .info-item {
                font-size: 0.75rem;
                gap: 0.25rem;
            }
            
            .resource-gauges {
                width: 100%;
                display: flex;
                gap: 1rem;
                margin-top: 0.5rem;
            }
            
            .gauge {
                flex: 1;
            }
        }
        
        /* Additional Mobile Optimizations */
        @media (max-width: 768px) {
            /* Mobile Header Improvements */
            .header {
                position: sticky;
                top: 0;
                z-index: 100;
                background: white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            }
            
            .header-actions {
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            
            .header-actions button,
            .header-actions a {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
            
            /* Mobile Calendar Improvements */
            .calendar-container {
                position: relative;
                padding-bottom: 1rem;
            }
            
            .calendar-container::after {
                content: '';
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 20px;
                background: linear-gradient(to right, transparent, rgba(245, 246, 250, 0.8));
                pointer-events: none;
            }
            
            .calendar-grid::-webkit-scrollbar {
                height: 6px;
            }
            
            .calendar-grid::-webkit-scrollbar-track {
                background: #f1f5f9;
                border-radius: 3px;
            }
            
            .calendar-grid::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 3px;
            }
            
            /* Touch-friendly booking cells */
            .hour-cell {
                position: relative;
                touch-action: manipulation;
            }
            
            .hour-cell.has-booking {
                cursor: pointer;
            }
            
            /* Mobile Fleet Section */
            .fleet-section {
                position: relative;
            }
            
            .vessels-list {
                scroll-behavior: smooth;
                -webkit-overflow-scrolling: touch;
            }
            
            .vessel-card {
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            }
            
            .vessel-card:active {
                transform: scale(0.98);
            }
            
            /* Mobile Modals */
            .modal {
                padding: 1rem;
            }
            
            .modal-content {
                width: 100%;
                max-width: 400px;
                max-height: 90vh;
                overflow-y: auto;
                border-radius: 16px;
            }
            
            /* Bottom Sheet Style for Mobile */
            @supports (backdrop-filter: blur(10px)) {
                .modal {
                    backdrop-filter: blur(10px);
                    background: rgba(0,0,0,0.3);
                }
            }
        }
        
        /* Small Mobile Specific */
        @media (max-width: 480px) {
            /* Keep Quick Actions visible but make them responsive */
            .quick-actions-section {
                margin: 0;
                padding: 0 !important;
            }
            
            .quick-actions-section h2 {
                padding: 0 0.75rem;
            }
            
            .quick-actions-grid {
                margin: 0;
                padding: 0 0.75rem;
            }
            
            /* Mobile-first Calendar */
            .calendar-week-nav {
                position: sticky;
                top: 60px;
                background: white;
                z-index: 90;
                padding: 0.5rem;
                margin: -1rem -1rem 1rem;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            
            /* Simplified Mobile View Toggle */
            @media (max-width: 480px) {
                .calendar-container {
                    margin: 0 -0.5rem;
                }
                
                .calendar-grid {
                    border-radius: 0;
                }
            }
            
            /* Mobile Staff Availability */
            .staff-availability-grid {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 0.5rem;
            }
            
            /* Compact Vessel Cards */
            .vessel-card {
                display: flex;
                align-items: center;
                gap: 1rem;
            }
            
            .vessel-info {
                flex: 1;
            }
            
            .resource-gauges {
                flex-direction: column;
                gap: 0.25rem;
            }
            
            /* Mobile-friendly Buttons */
            .btn {
                min-height: 44px;
                font-size: 0.9rem;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
            }
            
            /* Swipe Hint */
            .swipe-hint {
                display: block;
                text-align: center;
                color: #64748b;
                font-size: 0.75rem;
                margin-top: 0.5rem;
                padding: 0.5rem;
                background: #f8fafc;
                border-radius: 8px;
            }
        }
        
        /* Touch and Hover States */
        @media (hover: hover) {
            .vessel-card:hover {
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }
            
            .booking-item:hover {
                transform: translateX(4px);
            }
        }
        
        @media (hover: none) {
            /* Remove hover effects on touch devices */
            .nav-item:hover,
            .vessel-card:hover,
            .booking-item:hover {
                transform: none;
            }
            
            /* Add active states instead */
            .nav-item:active {
                background: rgba(27, 79, 114, 0.1);
            }
            
            .vessel-card:active {
                background: #f8fafc;
            }
        }
        
        /* Fix for any unintended red bars */
        .calendar-section::after,
        .fleet-section::before,
        .main-content > *::after {
            display: none !important;
        }
        
        /* Ensure clean spacing between sections */
        .main-content > section {
            position: relative;
            z-index: 1;
        }
        
        /* Ensure quick actions gradients are contained */
        .quick-actions-section {
            overflow: hidden !important;
        }
        
        /* Remove any unintended borders or lines */
        .calendar-section *,
        .fleet-section *,
        .quick-actions-section * {
            border-color: #e0e6ed !important;
        }
        
        /* Specifically hide any red elements that might be showing */
        div[style*="background: linear-gradient"][style*="#f5576c"],
        div[style*="background: linear-gradient"][style*="#f093fb"] {
            overflow: hidden !important;
            position: relative !important;
            z-index: 1 !important;
        }
        
        /* Logout button styling */
        .sidebar-nav button[onclick="logout()"] {
            background: #f1f5f9 !important;
            color: #64748b !important;
            transition: all 0.3s ease !important;
        }
        
        .sidebar-nav button[onclick="logout()"]:hover {
            background: #e2e8f0 !important;
            color: #475569 !important;
        }
        
        /* Logout button container */
        .logout-container {
            padding: 1.5rem;
            margin-top: auto;
            background: white;
        }
        
        /* Add-on indicator badge */
        .addon-indicator {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #ff9800;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            z-index: 15;
        }
        
        /* Ensure calendar events are positioned for absolute children */
        .calendar-event {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Mobile Overlay -->
        <div class="mobile-overlay" onclick="toggleMobileMenu()"></div>
        
        <!-- Left Sidebar Navigation -->
        <nav class="sidebar-nav" id="sidebarNav">
            <div class="logo-section">
                <img src="images/mbh-logo.png" alt="MBH Logo" class="logo">
                <div class="logo-text">MBH Portal</div>
                </div>
            
            <div class="sidebar-content">
                    <div class="view-toggle">
                    <span>Employee</span>
                        <div class="toggle-switch management" id="toggleSwitch" onclick="toggleView()">
                            <div class="toggle-slider"></div>
                        </div>
                    <span>Manager</span>
                    </div>
                
                <ul class="nav-items">
                    <li class="nav-item active" onclick="switchTab('overview', event)">
                        <i class="fas fa-chart-line"></i>
                        <span>Overview</span>
                    </li>
                    <li class="nav-item" onclick="switchTab('staff', event)">
                        <i class="fas fa-users"></i>
                        <span>Staff Management</span>
                    </li>
                    <li class="nav-item" onclick="window.location.href='vessel-maintenance.html'">
                        <i class="fas fa-ship"></i>
                        <span>Vessel Maintenance</span>
                    </li>
                    <li class="nav-item" onclick="window.location.href='ice-cream-sales.html'">
                        <i class="fas fa-ice-cream"></i>
                        <span>Ice Cream Boat</span>
                    </li>
                    <li class="nav-item" onclick="switchTab('announcements', event)">
                        <i class="fas fa-bullhorn"></i>
                        <span>Announcements</span>
                    </li>
                </ul>
    </div>

            <div class="logout-container">
                <button onclick="logout()" style="width: 100%; padding: 0.75rem; background: #f1f5f9; color: #64748b; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.3s ease;">
                    <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </nav>

        <!-- Dashboard Layout (Main + Right Sidebar) -->
        <div class="dashboard-layout">
            <!-- Main Content -->
            <main class="main-content">
            <!-- Header -->
            <header class="header">
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="greeting">
                    <h1>Hello <span id="userName">Manager</span>, welcome back!</h1>
                    <p>Here's what's happening with your marina today</p>
                </div>
                
                <div class="header-actions">
                    <div class="user-menu">
                        <div class="user-info">
                            <div class="user-name" id="userDisplayName">Loading...</div>
                            <div class="user-role">Manager</div>
                    </div>
                        <div class="user-avatar" id="userAvatar">?</div>
                </div>
                    </div>
            </header>
            
            <!-- Overview Tab Content -->
            <div id="overview-tab" class="tab-content active">
                <!-- Quick Actions Section -->
                <section class="quick-actions-section" style="margin-bottom: 2rem;">
                    <h2 class="section-title" style="margin-bottom: 1.5rem;">Quick Actions</h2>
                    <div class="quick-actions-grid">
                        <div class="quick-action-card" onclick="window.location.href='daily-run-sheet.html'" style="background: linear-gradient(135deg, #1B4F72 0%, #2E86AB 100%); border-radius: 12px; padding: 1.25rem; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.3s ease; color: white; overflow: hidden;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; overflow: hidden;">
                                <i class="fas fa-clipboard-list" style="font-size: 1.5rem; flex-shrink: 0;"></i>
                                <span style="font-size: 1.1rem; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Daily Run Sheet</span>
                            </div>
                        </div>
                        <div class="quick-action-card" onclick="window.location.href='daily-run-sheet-v2.html'" style="background: linear-gradient(135deg, #2E86AB 0%, #4CAF50 100%); border-radius: 12px; padding: 1.25rem; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.3s ease; color: white; overflow: hidden;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; overflow: hidden;">
                                <i class="fas fa-calendar-alt" style="font-size: 1.5rem; flex-shrink: 0;"></i>
                                <span style="font-size: 1.1rem; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Daily Run Sheet (Calendar)</span>
                            </div>
                            <div style="font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.9;">Enhanced calendar view</div>
                        </div>
                
                        <div class="quick-action-card" onclick="window.location.href='management-allocations.html'" style="background: linear-gradient(135deg, #1B4F72 0%, #2E86AB 100%); border-radius: 12px; padding: 1.25rem; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.3s ease; color: white; overflow: hidden;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; overflow: hidden;">
                                <i class="fas fa-users-cog" style="font-size: 1.5rem; flex-shrink: 0;"></i>
                                <span style="font-size: 1.1rem; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Staff Allocations</span>
                            </div>
                        </div>
                
                        <div class="quick-action-card" onclick="window.location.href='task-scheduler.html'" style="background: linear-gradient(135deg, #1B4F72 0%, #2E86AB 100%); border-radius: 12px; padding: 1.25rem; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.3s ease; color: white; overflow: hidden;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; overflow: hidden;">
                                <i class="fas fa-calendar-check" style="font-size: 1.5rem; flex-shrink: 0;"></i>
                                <span style="font-size: 1.1rem; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Task Scheduler</span>
                            </div>
                        </div>
                
                        <div class="quick-action-card" onclick="window.location.href='employee-directory.html'" style="background: linear-gradient(135deg, #1B4F72 0%, #2E86AB 100%); border-radius: 12px; padding: 1.25rem; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.3s ease; color: white; overflow: hidden;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; overflow: hidden;">
                                <i class="fas fa-address-book" style="font-size: 1.5rem; flex-shrink: 0;"></i>
                                <span style="font-size: 1.1rem; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Employee Directory</span>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Weekly Calendar Section -->
                <section class="calendar-section">
                    <div class="section-header">
                        <h2 class="section-title">Weekly Schedule</h2>
                        <div class="calendar-controls">
                            <button class="calendar-nav-btn" onclick="changeWeek(-1)" title="Previous week">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span class="current-week-display" id="currentWeekDisplay">Loading...</span>
                            <button class="calendar-nav-btn" onclick="changeWeek(1)" title="Next week">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <button class="calendar-nav-btn today-btn" onclick="goToToday()" title="Go to current week" style="margin-left: 10px;">
                                Today
                            </button>
                    </div>
                </div>
                    
                    <div class="weekly-calendar">
                        <div class="calendar-container">
                            <div class="calendar-list-view" id="calendarListView">
                                <!-- Calendar will be populated by JavaScript -->
                                <div class="calendar-loading" style="padding: 3rem; text-align: center;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #cbd5e1; margin-bottom: 1rem;"></i>
                                    <p style="color: #64748b;">Loading schedule...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Fleet Section -->
                <section class="fleet-section">
                    <div class="section-header">
                        <h2 class="section-title">Fleet</h2>
                        <a href="vessel-maintenance.html" class="view-all-btn">View All</a>
            </div>
                    
                    <div class="fleet-container">
                        <!-- Vessels List -->
                        <div class="vessels-list" id="vesselsList">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        
                        <!-- Map -->
                        <div id="fleetMap" style="height: 450px; width: 100%;"></div>
                    </div>
                </section>
        </div>

        <!-- Staff Management Tab -->
            <div id="staff-tab" class="tab-content" style="display: none;">
            <h2 style="margin-bottom: 1.5rem;">Staff Management</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div style="background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); overflow: hidden; cursor: pointer;" onclick="window.location.href='management-allocations.html'">
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, #1B4F72 0%, #2E86AB 100%); color: white;">
                        <div style="font-size: 1.3rem; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-calendar-alt"></i>
                            Weekly Schedule
                        </div>
                        <div style="opacity: 0.95; font-size: 0.9rem;">View and manage weekly staff allocations</div>
                    </div>
                </div>
                
                    <div style="background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); overflow: hidden; cursor: pointer;" onclick="window.location.href='employee-directory.html'">
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, #1B4F72 0%, #2E86AB 100%); color: white;">
                        <div style="font-size: 1.3rem; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-user-plus"></i>
                            Employee Directory
                        </div>
                        <div style="opacity: 0.95; font-size: 0.9rem;">Manage employee records and contacts</div>
                    </div>
                </div>
                
                    <div style="background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); overflow: hidden; cursor: pointer;" onclick="window.location.href='task-scheduler.html'">
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, #1B4F72 0%, #2E86AB 100%); color: white;">
                        <div style="font-size: 1.3rem; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-calendar-check"></i>
                            Task Scheduler
                        </div>
                        <div style="opacity: 0.95; font-size: 0.9rem;">Schedule and manage tasks with drag-and-drop</div>
                    </div>
                </div>
            </div>
            
            <div id="staffList" style="margin-top: 2rem;">
                <!-- Staff list will be loaded here -->
            </div>
        </div>

            <!-- Vessel Maintenance Tab - Redirects to vessel-maintenance.html -->
            <div id="vessels-tab" class="tab-content" style="display: none;">
                <!-- This tab is no longer used - vessel maintenance has its own page -->
        </div>

        <!-- Announcements Tab -->
            <div id="announcements-tab" class="tab-content" style="display: none;">
            <h2 style="margin-bottom: 1.5rem;">Staff Announcements</h2>
            
                <div class="announcement-form" style="background: white; padding: 2rem; border-radius: 16px; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                <h3 style="margin-bottom: 1rem;">Post New Announcement</h3>
                <form id="announcementForm">
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="form-label" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Title</label>
                            <input type="text" class="form-input" id="announcementTitle" placeholder="Enter announcement title" required style="width: 100%; padding: 0.75rem; border: 1px solid #e0e6ed; border-radius: 8px;">
                    </div>
                    
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="form-label" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Message</label>
                            <textarea class="form-textarea" id="announcementMessage" placeholder="Enter your announcement message" required style="width: 100%; padding: 0.75rem; border: 1px solid #e0e6ed; border-radius: 8px; min-height: 120px;"></textarea>
                    </div>
                    
                        <button type="submit" class="btn-submit" style="background: #1B4F72; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 500; cursor: pointer;">
                            <i class="fas fa-paper-plane"></i> Post Announcement
                        </button>
                    </form>
                            </div>
                
                <div id="announcementsList">
                    <!-- Announcements will be loaded here -->
                            </div>
                            </div>
        </main>
        
        <!-- Right Sidebar -->
        <aside class="right-sidebar">
            <!-- New Bookings -->
            <section class="sidebar-section">
                <div class="section-header">
                    <h3 class="section-title">New Bookings</h3>
                    <span class="new-indicator">
                        <i class="fas fa-circle"></i> Live
                    </span>
                    </div>
                    
                <div class="bookings-list" id="newBookingsList">
                    <!-- Loading state - will be replaced by real data -->
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading new bookings...</p>
            </div>
                </div>
            </section>
            
            <!-- Staff Availability -->
            <section class="sidebar-section">
                <div class="availability-header">
                    <h3 class="section-title">Staff Availability - Week View</h3>
                </div>

                <div class="staff-availability-grid" id="staffAvailabilityGrid">
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading staff availability...</p>
                    </div>
                </div>
            </section>
        </aside>
        </div> <!-- End of dashboard-layout -->
    </div>

    <script>
        // Initialize Supabase - must match the same instance as dashboard.html
        const SUPABASE_URL = 'https://etkugeooigiwahikrmzr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0a3VnZW9vaWdpd2FoaWtybXpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4MDI0OTcsImV4cCI6MjA2ODM3ODQ5N30.OPIYLsnPNNF7dP3SDCODIurzaa3X_Q3xEhfPO3rLJxU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // API configuration - Use backend proxy for security
        // All Airtable API calls should go through the server to protect API keys
        
        // Listen for auth state changes
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('Auth event:', event);
            
            // Handle sign out
            if (event === 'SIGNED_OUT') {
                window.location.href = 'auth.html';
            }
            
            // Handle initial session on page load
            if (event === 'INITIAL_SESSION' && !session) {
                console.log('No initial session, will redirect from checkAuth');
            }
        });
        
        // Check authentication on load
        async function checkAuth() {
            // Use getSession instead of getUser to avoid race conditions
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (error) {
                console.error('Auth error:', error);
                window.location.href = 'auth.html';
                return;
            }

            if (!session || !session.user) {
                console.log('No active session, redirecting to auth');
                window.location.href = 'auth.html';
                return;
            }
            
            const user = session.user;

            // Check if user has management access using role-based system
            const canAccessManagement = await RoleHelper.hasPermission('canAccessManagementDashboard');
            
            if (!canAccessManagement) {
                // Not a management user, redirect to regular dashboard
                console.log('User not authorized for management view, redirecting to dashboard');
                window.location.href = 'dashboard.html';
                return;
            }
            
            console.log('Management user authorized:', user.email);
            
            // Apply permission-based visibility to UI elements
            await RoleHelper.applyPermissionVisibility();
            
            // Store user email for announcements
            currentUserEmail = user.email;

            // Set user info
            const firstName = user.user_metadata?.full_name?.split(' ')[0] || 'Manager';
            document.getElementById('userName').textContent = firstName;
            document.getElementById('userDisplayName').textContent = user.user_metadata?.full_name || user.email;
            document.getElementById('userAvatar').textContent = (user.user_metadata?.full_name || user.email).charAt(0).toUpperCase();
            
            // Check for tab parameter in URL
            const urlParams = new URLSearchParams(window.location.search);
            const tabParam = urlParams.get('tab');
            if (tabParam && ['overview', 'staff', 'vessels', 'announcements'].includes(tabParam)) {
                switchTab(tabParam);
            }
            
            // Load initial data
            loadOverviewData();
            loadWeekData();
        }
        
        // Switch between tabs
        function switchTab(tabName, event) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.getElementById(`${tabName}-tab`).style.display = 'block';
            
            // Add active class to clicked nav item
            if (event && event.target) {
                const navItem = event.target.closest('.nav-item');
                if (navItem) {
                    navItem.classList.add('active');
                }
            } else {
                // Find nav item by text content
                document.querySelectorAll('.nav-item').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    if ((tabName === 'overview' && text.includes('overview')) ||
                        (tabName === 'staff' && text.includes('staff')) ||
                        (tabName === 'vessels' && text.includes('vessel')) ||
                        (tabName === 'announcements' && text.includes('announcement'))) {
                        item.classList.add('active');
                    }
                });
            }
            
            // Load tab-specific data
            switch(tabName) {
                case 'staff':
                    loadStaffData();
                    break;
                case 'vessels':
                    // Redirect to vessel maintenance page
                    window.location.href = 'vessel-maintenance.html';
                    break;
                case 'announcements':
                    loadAnnouncements();
                    break;
            }
        }
        
        // Toggle between employee and manager view
        function toggleView() {
            const toggleSwitch = document.getElementById('toggleSwitch');
            const isManagementView = toggleSwitch.classList.contains('management');
            
            if (isManagementView) {
                // Currently on management view, switch to employee view
                window.location.href = 'dashboard.html?view=regular';
            } else {
                // Currently showing employee view selected, but we're on management dashboard
                // This shouldn't happen, but handle it by staying on management
                window.location.href = 'management-dashboard.html';
            }
        }
        
        // Logout function
        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'auth.html';
        }
        
        // Toggle mobile menu
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebarNav');
            const overlay = document.querySelector('.mobile-overlay');
            
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
            
            // Prevent body scroll when menu is open
            if (sidebar.classList.contains('mobile-open')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }
        
        // Add mobile touch gestures
        let touchStartX = 0;
        let touchEndX = 0;
        let currentUserEmail = 'Admin'; // Store current user email
        
        function handleGesture() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;
            
            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    // Swipe left - could trigger next week
                    // List view doesn't need horizontal scroll check
                    // Proceed with week change
                } else {
                    // Swipe right - could trigger previous week
                    // List view doesn't need scroll position check
                    // Proceed with week change
                }
            }
        }
        
        // Add touch listeners for mobile
        if (window.innerWidth <= 768) {
            document.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            });
            
            document.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleGesture();
            });
        }
        
        // Load overview data
        async function loadOverviewData() {
            // Load all real-time data for the overview tab
            await loadNewBookings();
            await loadFleetData();
            await loadStaffAvailability();
        }
        
        // Load staff data
        async function loadStaffData() {
            const staffList = document.getElementById('staffList');
            staffList.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading staff data...</p></div>';
            
            // Since we have the quick action cards instead of a staff list, just show them
            staffList.innerHTML = ''; // Clear the loading state
        }
        
        // Load vessel data for maintenance tab - NO LONGER USED - Redirects to vessel-maintenance.html
        /*
        async function loadVesselData() {
            const vesselGrid = document.getElementById('vesselGrid');
            vesselGrid.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading vessel information...</p></div>';
            
            try {
                // Fetch vessels from backend API (same as fleet data)
                const response = await fetch('/api/vessels/maintenance-status');
                
                if (!response.ok) {
                    throw new Error('Failed to fetch vessel data');
                }
                
                const data = await response.json();
                const vessels = data.vessels || [];
                
                if (vessels.length === 0) {
                    vesselGrid.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-ship" style="font-size: 3rem; color: #94a3b8; margin-bottom: 1rem;"></i>
                            <p>No vessels found</p>
                        </div>
                    `;
                    return;
                }
                
                // Display vessels in a grid
                vesselGrid.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                        ${vessels.map(vessel => {
                            const condition = vessel.currentStatus?.condition || 'Unknown';
                            let statusClass = '';
                            let statusText = 'Unknown';
                            
                            if (condition?.includes('Ready') || condition?.includes('Good')) {
                                statusText = 'Ready';
                                statusClass = 'status-ready';
                            } else if (condition?.includes('Attention')) {
                                statusText = 'Needs Attention';
                                statusClass = 'status-attention';
                            } else if (condition?.includes('Major') || condition?.includes('Non-Operational')) {
                                statusText = 'Unavailable';
                                statusClass = 'status-unavailable';
                            }
                            
                            return `
                                <div class="vessel-maintenance-card">
                                    <div class="vessel-maintenance-header">
                                        <h3><i class="fas fa-ship"></i> ${vessel.name}</h3>
                                        <span class="vessel-status ${statusClass}">${statusText}</span>
                                    </div>
                                    <div class="vessel-maintenance-details">
                                        <div class="detail-item">
                                            <span class="detail-label">Location:</span>
                                            <span class="detail-value">${vessel.currentStatus?.location?.address || vessel.location || 'Unknown'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Last Check:</span>
                                            <span class="detail-value">${vessel.lastCheck?.timeFormatted || 'N/A'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Last completed by:</span>
                                            <span class="detail-value">${vessel.lastCheck?.completedBy || 'N/A'}</span>
                                        </div>
                                    </div>
                                    <div class="vessel-maintenance-actions">
                                        <a href="pre-departure-checklist.html?vessel=${encodeURIComponent(vessel.name)}" class="action-btn btn-primary">
                                            <i class="fas fa-clipboard-check"></i> Pre-Departure
                                        </a>
                                        <a href="post-departure-checklist.html?vessel=${encodeURIComponent(vessel.name)}" class="action-btn btn-secondary">
                                            <i class="fas fa-clipboard-list"></i> Post-Departure
                                        </a>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading vessel data:', error);
                vesselGrid.innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load vessel data</p>
                    </div>
                `;
            }
        }
        */
        
        // Load announcements
        async function loadAnnouncements() {
            const announcementsList = document.getElementById('announcementsList');
            announcementsList.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading announcements...</p></div>';
            
            try {
                const response = await fetch('/api/announcements');
                const data = await response.json();
                
                if (data.success && data.announcements.length > 0) {
                    announcementsList.innerHTML = data.announcements.map(announcement => `
                        <div class="announcement-item">
                            <div class="announcement-header">
                                <h4>${announcement.fields?.Title || 'Untitled'}</h4>
                                <button class="btn btn-sm btn-danger" onclick="deleteAnnouncement('${announcement.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <p>${announcement.fields?.Message || ''}</p>
                            <div class="announcement-meta">
                                <span>Posted by ${announcement.fields?.['Posted By'] || 'Admin'}</span>
                                <span>${announcement.fields?.['Expiry Date'] ? new Date(announcement.fields['Expiry Date']).toLocaleDateString() : 'No expiry'}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    announcementsList.innerHTML = '<p class="text-muted">No announcements posted yet.</p>';
                }
            } catch (error) {
                console.error('Error loading announcements:', error);
                announcementsList.innerHTML = '<p class="text-danger">Failed to load announcements</p>';
            }
        }
        
        // Calendar variables - Use actual current date
        let currentWeekStart = new Date();
        currentWeekStart.setHours(0, 0, 0, 0);
        const dayOfWeek = currentWeekStart.getDay();
        const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Adjust for Monday start
        currentWeekStart.setDate(currentWeekStart.getDate() + diff);
        
        // Helper function to format date as YYYY-MM-DD in local timezone
        function formatLocalDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Initialize calendar
        async function initCalendar() {
            updateWeekDisplay();
            await buildCalendarGrid();
        }

        // Update week display
        function updateWeekDisplay() {
            const endDate = new Date(currentWeekStart);
            endDate.setDate(endDate.getDate() + 6);
            
            const startStr = formatDate(currentWeekStart);
            const endStr = formatDate(endDate);
            
            document.getElementById('currentWeekDisplay').textContent = `${startStr} - ${endStr}`;
        }
        
        // Format date
        function formatDate(date) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${date.getDate()} ${months[date.getMonth()]}`;
        }
        
        // Build calendar list view
        async function buildCalendarGrid() {
            const listView = document.getElementById('calendarListView');
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const dayAbbr = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            
            // Show loading state
            listView.innerHTML = '<div class="calendar-loading" style="padding: 3rem; text-align: center;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #cbd5e1; margin-bottom: 1rem;"></i><p style="color: #64748b;">Loading schedule...</p></div>';
            
            try {
                // Get week start and end dates
                const startDate = new Date(currentWeekStart);
                const endDate = new Date(currentWeekStart);
                endDate.setDate(endDate.getDate() + 6);
                
                // Format dates for Airtable
                const startStr = formatLocalDate(startDate);
                const endStr = formatLocalDate(endDate);
                
                // Fetch bookings via API proxy - get all non-cancelled bookings and filter client-side
                const BOOKINGS_TABLE_ID = 'tblRe0cDmK3bG2kPf'; // Correct Bookings Dashboard table ID
                const response = await fetch(
                    `/api/airtable/applkAFOn2qxtu7tx/${BOOKINGS_TABLE_ID}?` +
                    `filterByFormula=${encodeURIComponent(`OR({Status}='PAID',{Status}='PART',{Status}='Confirmed',{Status}='Pending')`)}` +
                    `&fields[]=Customer Name&fields[]=Booking Date&fields[]=Start Time&fields[]=Finish Time` +
                    `&fields[]=Boat&fields[]=Booked Boat Type&fields[]=Status` +
                    `&fields[]=Onboarding Employee&fields[]=Deloading Employee&fields[]=Add-ons` +
                    `&pageSize=100`,
                    {
                        method: 'GET'
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch bookings: ${response.status}`);
                }
                
                    const data = await response.json();
                    const allBookings = data.records || [];
                    
                // Filter bookings by date on client side
                const bookings = allBookings.filter(record => {
                    const bookingDate = record.fields['Booking Date'];
                    if (!bookingDate) return false;
                    
                    // Parse date properly to avoid timezone issues
                    const date = new Date(bookingDate + 'T00:00:00');
                    const dateStr = formatLocalDate(date);
                    
                    // Compare dates as strings to avoid timezone issues
                    return dateStr >= startStr && dateStr <= endStr;
                });
                
                // Debug: Log fetched bookings
                console.log(`Fetched ${allBookings.length} total bookings, ${bookings.length} for week ${startStr} to ${endStr}`);
                bookings.forEach(record => {
                    const addOns = record.fields['Add-ons'] || 'None';
                    console.log(`Booking: ${record.fields['Customer Name']} on ${record.fields['Booking Date']} at ${record.fields['Start Time']} - Status: ${record.fields['Status']} - Add-ons: ${addOns}`);
                });
                
                // Group bookings by date and time
                const bookingsByDateAndTime = {};
                bookings.forEach(record => {
                    const fields = record.fields;
                    const bookingDate = new Date(fields['Booking Date'] + 'T00:00:00');
                    const dateKey = formatLocalDate(bookingDate);
                    
                    // Parse start time
                    const startTime = parseTimeToSlot(fields['Start Time']);
                    if (startTime) {
                        const key = `${dateKey}-${startTime}`;
                        if (!bookingsByDateAndTime[key]) {
                            bookingsByDateAndTime[key] = [];
                        }
                        bookingsByDateAndTime[key].push({
                            customer: fields['Customer Name'],
                            boat: fields['Booked Boat Type'] || 'Boat',
                            status: fields['Status'],
                            hasStaff: !!(fields['Onboarding Employee']?.[0] || fields['Deloading Employee']?.[0]),
                            addOns: fields['Add-ons'] || ''
                        });
                    } else {
                        console.warn(`Could not parse time for booking: ${fields['Customer Name']} with time: ${fields['Start Time']}`);
                    }
                });
                
                // Build the list view HTML
                let html = '';
                
                // Group bookings by date
                const bookingsByDate = {};
                bookings.forEach(record => {
                    const fields = record.fields;
                    const bookingDate = new Date(fields['Booking Date'] + 'T00:00:00');
                    const dateKey = formatLocalDate(bookingDate);
                    
                    if (!bookingsByDate[dateKey]) {
                        bookingsByDate[dateKey] = [];
                    }
                    
                    bookingsByDate[dateKey].push({
                        id: record.id,
                        customer: fields['Customer Name'],
                        boat: fields['Booked Boat Type'] || 'Boat',
                        status: fields['Status'],
                        startTime: fields['Start Time'],
                        endTime: fields['Finish Time'],
                        hasStaff: !!(fields['Onboarding Employee']?.[0] || fields['Deloading Employee']?.[0]),
                        addOns: fields['Add-ons'] || ''
                    });
                });
                
                // Create list view for each day
                for (let i = 0; i < 7; i++) {
                    const date = new Date(currentWeekStart);
                    date.setDate(date.getDate() + i);
                    const dateKey = formatLocalDate(date);
                    const isToday = isDateToday(date);
                    const dayBookings = bookingsByDate[dateKey] || [];
                    
                    // Sort bookings by start time
                    dayBookings.sort((a, b) => {
                        const timeA = parseTime(a.startTime);
                        const timeB = parseTime(b.startTime);
                        return timeA - timeB;
                    });
                    
                    html += `
                        <div class="calendar-day-group">
                            <div class="calendar-day-header ${isToday ? 'today' : ''}">
                                <span>${days[i]}</span>
                                <span class="calendar-day-date">${date.getDate()}/${(date.getMonth() + 1).toString().padStart(2, '0')}</span>
                            </div>
                            <div class="calendar-bookings-list">
                    `;
                    
                    if (dayBookings.length === 0) {
                        html += '<div class="calendar-no-bookings">No bookings</div>';
                    } else {
                        dayBookings.forEach(booking => {
                            const hasAddOns = booking.addOns && booking.addOns.trim() !== '' && booking.addOns !== 'None';
                            
                            html += `
                                <div class="calendar-booking-item ${booking.hasStaff ? 'staffed' : ''}" onclick="window.location.href='management-allocations.html?bookingId=${booking.id}'">
                                    <div class="calendar-booking-time">${formatTimeDisplay(booking.startTime)}</div>
                                    <div class="calendar-booking-details">
                                        <div class="calendar-booking-vessel">${booking.boat}</div>
                                        <div class="calendar-booking-customer">${booking.customer}</div>
                                    </div>
                                    ${hasAddOns ? `<div class="calendar-booking-addon"><i class="fas fa-plus"></i> Add-ons</div>` : ''}
                                </div>
                            `;
                        });
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                listView.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading calendar data:', error);
                listView.innerHTML = `
                    <div class="error-state" style="padding: 3rem; text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #ef4444; margin-bottom: 1rem;"></i>
                        <p style="color: #64748b;">Failed to load calendar data</p>
                    </div>
                `;
            }
        }
        
        // Helper function to parse time string to numeric value for sorting
        function parseTime(timeStr) {
            if (!timeStr) return 0;
            
            // Try parsing 12-hour format like "08:45 am" or "1:30 PM"
            let timeParts = timeStr.toLowerCase().match(/(\d{1,2}):(\d{2})\s*(am|pm)/);
            
            if (timeParts) {
                let hour = parseInt(timeParts[1]);
                const minute = parseInt(timeParts[2]);
                const isPM = timeParts[3] === 'pm';
                
                // Convert to 24-hour format
                if (isPM && hour !== 12) hour += 12;
                if (!isPM && hour === 12) hour = 0;
                
                return hour * 60 + minute;
            }
            
            // Try parsing 24-hour format like "09:00" or "13:30"
            timeParts = timeStr.match(/(\d{1,2}):(\d{2})/);
            if (timeParts) {
                const hour = parseInt(timeParts[1]);
                const minute = parseInt(timeParts[2]);
                return hour * 60 + minute;
            }
            
            return 0;
        }
        
        // Helper function to format time for display
        function formatTimeDisplay(timeStr) {
            if (!timeStr) return '';
            
            // Clean up common formats
            return timeStr.replace(/\s+/g, ' ').trim();
        }
        
        // Helper function to parse time string to time slot
        function parseTimeToSlot(timeStr) {
            if (!timeStr) return null;
            
            // Try parsing 12-hour format like "08:45 am" or "1:30 PM"
            let timeParts = timeStr.toLowerCase().match(/(\d{1,2}):(\d{2})\s*(am|pm)/);
            let hour;
            
            if (timeParts) {
                hour = parseInt(timeParts[1]);
                const isPM = timeParts[3] === 'pm';
                
                // Convert to 24-hour format
                if (isPM && hour !== 12) hour += 12;
                if (!isPM && hour === 12) hour = 0;
            } else {
                // Try parsing 24-hour format like "09:00" or "13:30"
                timeParts = timeStr.match(/(\d{1,2}):(\d{2})/);
                if (timeParts) {
                    hour = parseInt(timeParts[1]);
                } else {
                    console.warn(`Unable to parse time format: ${timeStr}`);
                    return null;
                }
            }
            
            // Map to nearest 2-hour slot
            if (hour < 9) return '8 AM';
            else if (hour < 11) return '10 AM';
            else if (hour < 13) return '12 PM';
            else if (hour < 15) return '2 PM';
            else if (hour < 17) return '4 PM';
            else if (hour < 19) return '6 PM';
            else return '8 PM'; // Late bookings
        }
        
        // Check if date is today
        function isDateToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }
        
        // Change week
        async function changeWeek(direction) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
            updateWeekDisplay();
            await buildCalendarGrid();
        }
        
        // Go to current week
        async function goToToday() {
            // Reset to current week
            currentWeekStart = new Date();
            currentWeekStart.setHours(0, 0, 0, 0);
            const dayOfWeek = currentWeekStart.getDay();
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Adjust for Monday start
            currentWeekStart.setDate(currentWeekStart.getDate() + diff);
            
            updateWeekDisplay();
            await buildCalendarGrid();
        }
        
        // Add vessel card interactivity to link with map markers
        function initializeVesselInteractivity() {
            document.querySelectorAll('.vessel-card').forEach(card => {
                card.addEventListener('click', function() {
                    const vesselName = this.getAttribute('data-vessel-name');
                    
                    // Find the corresponding marker
                    const marker = fleetMarkers.find(m => m.vesselName === vesselName);
                    
                    if (marker) {
                        // Close any open info windows
                        fleetMarkers.forEach(m => {
                            if (m.infoWindow) m.infoWindow.close();
                        });
                        
                        // Open the info window for the clicked vessel
                        marker.infoWindow.open(fleetMap, marker);
                        
                        // Center and zoom the map on the marker
                        fleetMap.setCenter(marker.getPosition());
                        fleetMap.setZoom(15);
                        
                        // Smooth scroll to map if not in view
                        const mapContainer = document.getElementById('fleetMap');
                        if (mapContainer) {
                            mapContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    } else {
                        console.warn(`No marker found for vessel: ${vesselName}`);
                    }
                });
            });
        }
        
        // Update booking timestamps
        function updateBookingTimestamps() {
            const bookingTimes = document.querySelectorAll('.booking-time');
            bookingTimes.forEach((element, index) => {
                const times = ['Just now', '2 min ago', '5 min ago', '23 min ago', '1 hour ago', '2 hours ago'];
                if (index < times.length) {
                    element.textContent = `Added ${times[index]}`;
                }
            });
        }
        
        // Simulate new booking arrival - DEPRECATED - Now using real data
        function simulateNewBooking() {
            const bookingsList = document.getElementById('newBookingsList');
            const existingBookings = bookingsList.querySelectorAll('.booking-item');
            
            // Random new booking data
            const names = ['Alex Morgan', 'Sam Taylor', 'Jordan Lee', 'Casey Brown'];
            const vessels = ['8 Person BBQ Boat', '4 Person Polycraft', '12 Person BBQ Boat', 'Junior', 'Sandstone'];
            const prices = ['$220', '$350', '$450', '$180', '$280'];
            
            const randomName = names[Math.floor(Math.random() * names.length)];
            const randomVessel = vessels[Math.floor(Math.random() * vessels.length)];
            const randomPrice = prices[Math.floor(Math.random() * prices.length)];
            const randomDate = `Dec ${Math.floor(Math.random() * 7) + 24}`;
            
            // Create new booking element
            const newBooking = document.createElement('div');
            newBooking.className = 'booking-item new-booking';
            newBooking.style.opacity = '0';
            newBooking.innerHTML = `
                <div class="booking-details">
                    <h4>${randomName}</h4>
                    <p>${randomVessel}  ${randomDate}</p>
                    <span class="booking-time">Added just now</span>
                </div>
                <div class="booking-stats">
                    <div class="booking-value">${randomPrice}</div>
                    <div class="booking-label">Total</div>
                </div>
            `;
            
            // Insert at the beginning
            bookingsList.insertBefore(newBooking, bookingsList.firstChild);
            
            // Animate in
            setTimeout(() => {
                newBooking.style.transition = 'all 0.5s ease';
                newBooking.style.opacity = '1';
            }, 100);
            
            // Remove oldest booking if more than 5
            if (existingBookings.length >= 4) {
                const lastBooking = existingBookings[existingBookings.length - 1];
                lastBooking.style.transition = 'all 0.5s ease';
                lastBooking.style.opacity = '0';
                setTimeout(() => lastBooking.remove(), 500);
            }
            
            // Flash the live indicator
            const indicator = document.querySelector('.new-indicator');
            indicator.style.color = '#ef4444';
            setTimeout(() => {
                indicator.style.transition = 'color 0.5s ease';
                indicator.style.color = '#10b981';
            }, 200);
        }
        
        // Load week data (for calendar)
        async function loadWeekData() {
            // Initialize calendar with current week
                updateWeekDisplay();
            await buildCalendarGrid();
            
            // Load other real-time data
            await loadFleetData();
            await loadNewBookings();
            await loadStaffAvailability();
        }
        
        // Load fleet data
        async function loadFleetData() {
            const vesselsList = document.getElementById('vesselsList');
            if (!vesselsList) return;
            
            try {
                // Fetch vessel data from backend API
                const response = await fetch('/api/vessels/maintenance-status');
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch vessels: ${response.status}`);
                }
                
                const data = await response.json();
                const vessels = data.vessels || [];
                
                if (vessels.length === 0) {
                    vesselsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-ship"></i>
                            <p>No vessels found</p>
                        </div>
                    `;
                    return;
                }
                
                // Generate vessel items HTML - API returns processed data
                vesselsList.innerHTML = vessels.map(vessel => {
                    // API returns nested structure with level and percentage
                    const fuelLevel = vessel.currentStatus?.fuel?.level;
                    const gasLevel = vessel.currentStatus?.gas?.level;
                    const waterLevel = vessel.currentStatus?.water?.level;
                    const condition = vessel.currentStatus?.condition || 'Unknown';
                    
                    // Use percentage directly from API or calculate fallback
                    const fuelPercentage = vessel.currentStatus?.fuel?.percentage || getLevelPercentage(fuelLevel);
                    const gasPercentage = vessel.currentStatus?.gas?.percentage || getLevelPercentage(gasLevel);
                    const waterPercentage = vessel.currentStatus?.water?.percentage || getLevelPercentage(waterLevel);
                    
                    // Extract suburb from location
                    let locationText = vessel.currentStatus?.location?.address || vessel.location || 'Unknown Location';
                    
                    // Check if using fixed location
                    const fixedLocations = {
                        'Work Boat': 'Fergusons Marina',
                        'Ice Cream Boat': 'Dalbora The Spit',
                        'Sandstone': 'Balmoral Mooring',
                        'Pumice Stone': 'Little Manly Commercial Mooring',
                        'Junior': 'Seaforth Mooring',
                        'Polycraft Yam': 'Manly Boat Hire Base',
                        'Polycraft Merc': 'Manly Boat Hire Base'
                    };
                    
                    const isFixedLocation = !vessel.currentStatus?.location?.latitude && fixedLocations[vessel.name];
                    if (isFixedLocation) {
                        locationText = fixedLocations[vessel.name];
                    }
                    
                    const suburb = extractSuburb(locationText);
                    
                    // Determine status badge based on condition
            let statusText = 'Unknown';
                    let statusClass = '';
                    if (condition?.includes('Ready') || condition?.includes('Good')) {
                        statusText = 'Ready';
                        statusClass = '';
                    } else if (condition?.includes('Attention')) {
                statusText = 'Needs Attention';
                        statusClass = 'maintenance';
                    } else if (condition?.includes('Major') || condition?.includes('Non-Operational')) {
                        statusText = 'Unavailable';
                        statusClass = 'unavailable';
                    }
                    
                    return `
                        <div class="vessel-card" data-vessel-name="${vessel.name}" style="cursor: pointer;">
                <div class="vessel-header">
                                <div class="vessel-name">
                                    <i class="fas fa-ship"></i> ${vessel.name || 'Unknown'}
                    </div>
                                <div class="status-badge ${statusClass}">
                                    ${statusText}
                </div>
                            </div>
                    <div class="vessel-location">
                                <i class="fas ${isFixedLocation ? 'fa-anchor' : 'fa-map-marker-alt'}"></i>
                                <span>Location: ${suburb}${isFixedLocation ? ' (Storage)' : ''}</span>
                            </div>
                            <div class="resource-gauges">
                                ${renderGauge('Fuel', fuelPercentage)}
                                ${renderGauge('Gas', gasPercentage)}
                                ${renderGauge('Water', waterPercentage)}
                        </div>
                    </div>
                    `;
                }).join('');
                
                // Initialize vessel item interactivity
                initializeVesselInteractivity();
                
            } catch (error) {
                console.error('Error loading fleet data:', error);
                vesselsList.innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load vessels</p>
                    </div>
                `;
            }
        }
        
        // Helper function to convert level strings to percentages
        function getLevelPercentage(level) {
            const levelMap = {
                'Empty': 0,
                'Quarter': 25,
                'Half': 50,
                'Three-Quarter': 75,
                'Full': 100
            };
            return levelMap[level] || 0;
        }
        
        // Helper function to extract suburb from address
        function extractSuburb(address) {
            if (!address || address === 'Unknown Location') {
                return 'Unknown Location';
            }
            
            // Common patterns for Australian addresses
            // Example: "43 Seaforth Cres, Seaforth NSW 2092, Australia"
            // We want to extract "Seaforth"
            
            const parts = address.split(',');
            if (parts.length >= 2) {
                // Try to get the second part which usually contains suburb and state
                const suburbPart = parts[1].trim();
                // Remove state code and postcode
                const suburbMatch = suburbPart.match(/^([^0-9]+?)(?:\s+[A-Z]{2,3})?\s*\d*$/);
                if (suburbMatch) {
                    return suburbMatch[1].trim();
                }
            }
            
            // Fallback - return the first part of the address
            return parts[0] || address;
        }
        
        // Get initials from name
        function getInitials(name) {
            if (!name) return '?';
            const parts = name.trim().split(' ');
            if (parts.length === 1) {
                return parts[0].substring(0, 2).toUpperCase();
            }
            return parts[0][0].toUpperCase() + parts[parts.length - 1][0].toUpperCase();
        }
        
        // Render individual gauge
        function renderGauge(label, percentage) {
            const fillClass = percentage < 25 ? 'low' : percentage < 50 ? 'medium' : '';
            
            return `
                <div class="gauge">
                    <div class="gauge-label">${label}</div>
                    <div class="gauge-bar">
                        <div class="gauge-fill ${fillClass}" style="width: ${percentage}%;"></div>
                    </div>
                    <div class="gauge-value">${percentage}%</div>
                </div>
            `;
        }
        
        // Load new bookings from Airtable
        async function loadNewBookings() {
            const bookingsList = document.getElementById('newBookingsList');
            if (!bookingsList) return;
            
            try {
                // Get today's date and calculate recent bookings (last 7 days)
                const today = new Date();
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(today.getDate() - 7);
                
                // Format dates for Airtable datetime comparison
                const sevenDaysAgoISO = sevenDaysAgo.toISOString();
                
                // Fetch recent bookings via API proxy
                const BOOKINGS_TABLE_ID = 'tblRe0cDmK3bG2kPf'; // Correct Bookings Dashboard table ID
                const response = await fetch(
                    `/api/airtable/applkAFOn2qxtu7tx/${BOOKINGS_TABLE_ID}?` +
                    `filterByFormula=${encodeURIComponent(`AND({Created Time}>='${sevenDaysAgoISO}',{Status}!='CANC')`)}` +
                    `&sort[0][field]=Created Time&sort[0][direction]=desc` +
                    `&maxRecords=5` +
                    `&fields[]=Customer Name&fields[]=Booking Date&fields[]=Total Amount` +
                    `&fields[]=Created Time&fields[]=Booked Boat Type&fields[]=Booking Items`,
                    {
                        method: 'GET'
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch bookings: ${response.status}`);
                }
                
                const data = await response.json();
                const bookings = data.records || [];
                
                if (bookings.length === 0) {
                    bookingsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-calendar-check"></i>
                            <p>No new bookings in the last 7 days</p>
                        </div>
                    `;
                    return;
                }
                
                // Generate booking items HTML
                bookingsList.innerHTML = bookings.map(record => {
                    const fields = record.fields;
                    
                    // Handle Created Time field
                    let timeAgo = 'recently';
                    if (fields['Created Time']) {
                        const createdTime = new Date(fields['Created Time']);
                        if (!isNaN(createdTime.getTime())) {
                            timeAgo = getTimeAgo(createdTime);
                        }
                    }
                    
                    const bookingDate = new Date(fields['Booking Date']);
                    
                    // Extract boat type from fields
                    const boatType = fields['Booked Boat Type'] || 
                                   extractBoatTypeFromItems(fields['Booking Items']) || 
                                   'Boat';
                    
                    return `
                        <div class="booking-item new-booking">
                            <div class="booking-details">
                                <h4>${fields['Customer Name'] || 'Unknown Customer'}</h4>
                                <p>${boatType}  ${bookingDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</p>
                                <span class="booking-time">Added ${timeAgo}</span>
                            </div>
                            <div class="booking-stats">
                                <div class="booking-value">$${fields['Total Amount'] || 0}</div>
                                <div class="booking-label">Total</div>
                        </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading new bookings:', error);
                bookingsList.innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load bookings</p>
                    </div>
                `;
            }
        }
        
        // Helper function to calculate time ago
        function getTimeAgo(date) {
            const now = new Date(); // Use actual current date/time
            
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) {
                return 'just now';
            } else if (diffMins < 60) {
                return `${diffMins} min ago`;
            } else if (diffHours < 24) {
                return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            } else if (diffDays < 7) {
                return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
                } else {
                // For older bookings, show the date
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }
        
        // Helper function to extract boat type from booking items
        function extractBoatTypeFromItems(items) {
            if (!items) return null;
            
            const boatTypes = {
                '8personbbqboat': '8 Person BBQ Boat',
                '12personbbqboat': '12 Person BBQ Boat',
                'polycraft': '4 Person Polycraft',
                'junior': 'Junior'
            };
            
            for (const [key, value] of Object.entries(boatTypes)) {
                if (items.toLowerCase().includes(key)) {
                    return value;
                }
            }
            
            return null;
        }
        
        // Load staff availability widget
        async function loadStaffAvailability() {
            const staffAvailabilityGrid = document.getElementById('staffAvailabilityGrid');
            if (!staffAvailabilityGrid) return;
            
            try {
                // Get current week's dates (Monday to Sunday)
                const weekStart = new Date(currentWeekStart);
                const weekDates = [];
                const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                
                // Generate dates for the week starting from Monday
                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + i);
                    weekDates.push({
                        date: date,
                        dateStr: formatLocalDate(date),
                        dayName: dayNames[i] // Use index directly since we're starting from Monday
                    });
                }
                
                // Fetch roster data for the week via API proxy
                const ROSTER_TABLE_ID = 'tblwwK1jWGxnfuzAN';
                const rosterResponse = await fetch(
                    `/api/airtable/applkAFOn2qxtu7tx/${ROSTER_TABLE_ID}?` +
                    `filterByFormula=${encodeURIComponent(`AND({Date} >= '${weekDates[0].dateStr}', {Date} <= '${weekDates[6].dateStr}')`)}` +
                    `&fields[]=Employee&fields[]=Employee%20Name&fields[]=Date&fields[]=Available%20From&fields[]=Available%20Until&fields[]=Notes`,
                    {
                        method: 'GET'
                    }
                );
                
                if (!rosterResponse.ok) {
                    const errorData = await rosterResponse.json();
                    console.error('Roster API error:', errorData);
                    throw new Error(`Failed to fetch roster: ${rosterResponse.status}`);
                }
                
                const rosterData = await rosterResponse.json();
                const rosterRecords = rosterData.records || [];
                console.log(`Fetched ${rosterRecords.length} roster records for week ${weekDates[0].dateStr} to ${weekDates[6].dateStr}`);
                
                // Extract employee info from roster data
                // The roster already includes Employee Name, so we don't need a separate API call
                const employees = {};
                
                // Build employee map from roster data
                rosterRecords.forEach(record => {
                    const employeeId = record.fields['Employee']?.[0];
                    const employeeName = record.fields['Employee Name'];
                    
                    if (employeeId && employeeName && !employees[employeeId]) {
                        employees[employeeId] = {
                            name: employeeName,
                            type: 'Unknown' // We'll default to 'Casual' styling unless we fetch employment type
                        };
                    }
                });
                
                console.log(`Found ${Object.keys(employees).length} unique employees in roster data`);
                
                if (Object.keys(employees).length === 0) {
                    staffAvailabilityGrid.innerHTML = '<div class="no-data">No staff availability for this week</div>';
                    return;
                }
                
                // Optionally fetch employment types
                // We'll fetch all employees and filter client-side to get employment types
                try {
                    const EMPLOYEES_TABLE_ID = 'tbltAE4NlNePvnkpY';
                    const employeesResponse = await fetch(
                        `/api/airtable/applkAFOn2qxtu7tx/${EMPLOYEES_TABLE_ID}?` +
                        `fields[]=Name&fields[]=Staff%20Type&pageSize=100`,
                        {
                            method: 'GET'
                        }
                    );
                    
                    if (employeesResponse.ok) {
                        const employeesData = await employeesResponse.json();
                        // Update employment types for matched employees
                        employeesData.records.forEach(record => {
                            const employeeName = record.fields['Name'];
                            // Find matching employee by name
                            Object.keys(employees).forEach(id => {
                                if (employees[id].name === employeeName) {
                                    employees[id].type = record.fields['Staff Type'] || 'Casual';
                                }
                            });
                        });
                    }
                } catch (error) {
                    console.log('Could not fetch employment types, using defaults:', error);
                }
                
                // Group roster by date
                const rosterByDate = {};
                weekDates.forEach(wd => {
                    rosterByDate[wd.dateStr] = [];
                });
                
                rosterRecords.forEach(record => {
                    const date = record.fields['Date'];
                    const employeeId = record.fields['Employee']?.[0];
                    if (date && employeeId && rosterByDate[date] !== undefined) {
                        const employee = employees[employeeId];
                        if (employee) {
                            rosterByDate[date].push({
                                name: employee.name,
                                type: employee.type,
                                initials: getInitials(employee.name)
                            });
                        }
                    }
                });
                
                // Build the grid HTML
                let gridHTML = '';
                // Get today's date
                const today = new Date();
                const todayStr = formatLocalDate(today);
                
                weekDates.forEach(wd => {
                    const staff = rosterByDate[wd.dateStr] || [];
                    const isToday = wd.dateStr === todayStr;
                    
                    gridHTML += `
                        <div class="day-column">
                            <div class="day-label${isToday ? ' today' : ''}">${wd.dayName}</div>
                            <div class="staff-initials-container">
                                ${staff.length > 0 ? 
                                    staff.map(s => `
                                        <div class="staff-initial-circle ${
                                            s.type === 'Unknown' ? 'casual' : 
                                            s.type.toLowerCase().includes('full') ? 'full-time' : 'casual'
                                        }" 
                                             title="${s.name} (${s.type})" 
                                             data-name="${s.name}">
                                            ${s.initials}
                                        </div>
                                    `).join('') :
                                    '<div class="no-staff">-</div>'
                                }
                            </div>
                        </div>
                    `;
                });
                
                staffAvailabilityGrid.innerHTML = gridHTML;
                
            } catch (error) {
                console.error('Error loading staff availability:', error);
                staffAvailabilityGrid.innerHTML = '<div class="error-state">Failed to load staff availability</div>';
            }
        }
        
        // Google Maps functions
        let fleetMap;
        let fleetMarkers = [];
        
        // Google Maps API key is now loaded from server configuration
        let GOOGLE_MAPS_API_KEY = null;
        // NOTE: If you see "RefererNotAllowedMapError", the API key needs to be authorized for your domain
        // in Google Cloud Console: https://console.cloud.google.com/apis/credentials
        
        // Initialize Google Maps for fleet
        function initFleetMap() {
            const mapContainer = document.getElementById('fleetMap');
            if (!mapContainer) return;
            
            // Check if Google Maps loaded successfully
            if (!window.google || !window.google.maps || !window.google.maps.Map) {
                mapContainer.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: #666;">
                        <div style="margin-bottom: 1rem;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #f59e0b;"></i>
                        </div>
                        <p style="margin-bottom: 0.5rem;">Google Maps is not available</p>
                        <p style="font-size: 0.875rem;">The API key needs to be authorized for this domain.</p>
                        <p style="font-size: 0.75rem; margin-top: 1rem;">Vessels with locations are shown in the list on the left.</p>
                    </div>
                `;
                return;
            }
            
            // Create map centered on Sydney Harbour
            fleetMap = new google.maps.Map(mapContainer, {
                center: { lat: -33.810856, lng: 151.256586 },
                zoom: 13,
                    mapTypeId: 'hybrid',
                mapTypeControl: true,
                mapTypeControlOptions: {
                    style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                    position: google.maps.ControlPosition.TOP_LEFT
                },
                zoomControl: true,
                zoomControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_CENTER
                },
                streetViewControl: false,
                fullscreenControl: true,
                fullscreenControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_TOP
                }
            });
            
            // Load vessel data and add markers
            loadVesselMarkers();
        }
        
        // Load vessel markers on the map
        async function loadVesselMarkers() {
            try {
                // Fetch vessel data from API
                const response = await fetch('/api/vessels/maintenance-status');
                if (!response.ok) throw new Error('Failed to fetch vessel data');
                
                const data = await response.json();
                const vessels = data.vessels || [];
                
                // Clear existing markers
                fleetMarkers.forEach(marker => marker.setMap(null));
                fleetMarkers = [];
                
                // Fixed locations for vessels without GPS data
                const fixedLocations = {
                    'Work Boat': {
                        latitude: -33.8126,
                        longitude: 151.2738,
                        address: 'Fergusons Marina',
                        captured: true,
                        isFixed: true
                    },
                    'Ice Cream Boat': {
                        latitude: -33.8058,
                        longitude: 151.2485,
                        address: 'Dalbora The Spit',
                        captured: true,
                        isFixed: true
                    },
                    'Sandstone': {
                        latitude: -33.8028,
                        longitude: 151.2659,
                        address: 'Balmoral Mooring',
                        captured: true,
                        isFixed: true
                    },
                    'Pumice Stone': {
                        latitude: -33.8074,
                        longitude: 151.2723,
                        address: 'Little Manly Commercial Mooring',
                        captured: true,
                        isFixed: true
                    },
                    'Junior': {
                        latitude: -33.7974,
                        longitude: 151.2508,
                        address: 'Seaforth Mooring',
                        captured: true,
                        isFixed: true
                    },
                    'Polycraft Yam': {
                        latitude: -33.8085,
                        longitude: 151.2735,
                        address: 'Manly Boat Hire Base',
                        captured: true,
                        isFixed: true
                    },
                    'Polycraft Merc': {
                        latitude: -33.8085,
                        longitude: 151.2735,
                        address: 'Manly Boat Hire Base',
                        captured: true,
                        isFixed: true
                    }
                };
                
                // Add marker for each vessel with location
                vessels.forEach(vessel => {
                    let location = vessel.currentStatus?.location;
                    
                    // Use fixed location if vessel doesn't have GPS data
                    if (!location?.latitude && fixedLocations[vessel.name]) {
                        location = fixedLocations[vessel.name];
                    }
                    
                    if (location?.latitude) {
                        const position = { 
                            lat: location.latitude, 
                            lng: location.longitude 
                        };
                        
                        // Determine marker color based on vessel condition
                        const condition = vessel.currentStatus?.condition || 'Unknown';
                        let markerColor = 'red';
                        if (condition?.includes('Ready') || condition?.includes('Good')) {
                            markerColor = 'green';
                        } else if (condition?.includes('Attention')) {
                            markerColor = 'yellow';
                        }
                        
                        // Create custom marker
                        const marker = new google.maps.Marker({
                            position: position,
                            map: fleetMap,
                            title: vessel.name,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 10,
                                fillColor: markerColor,
                                fillOpacity: 0.8,
                                strokeColor: 'white',
                                strokeWeight: 2
                            }
                        });
                        
                        // Store vessel name with the marker for later lookup
                        marker.vesselName = vessel.name;
                        
                        // Create info window content
                        const locationType = location.isFixed ? 'Storage Location' : 'Last Known Location';
                        const infoContent = `
                            <div style="padding: 10px;">
                                <h4 style="margin: 0 0 10px 0;">${vessel.name}</h4>
                                <p style="margin: 5px 0;"><strong>Status:</strong> ${condition}</p>
                                <p style="margin: 5px 0;"><strong>${locationType}:</strong> ${location.address || 'Unknown'}</p>
                                ${location.lastModified ? `<p style="margin: 5px 0;"><small>Updated: ${new Date(location.lastModified).toLocaleString('en-AU')}</small></p>` : ''}
                                ${location.isFixed ? `<p style="margin: 5px 0; font-style: italic; color: #666;"><small> Default storage location</small></p>` : ''}
                                <div style="margin-top: 10px;">
                                    <span style="margin-right: 10px;"> ${vessel.currentStatus?.fuel?.level || 'N/A'}</span>
                                    <span> ${vessel.currentStatus?.water?.level || 'N/A'}</span>
                                </div>
                            </div>
                        `;
                        
                        const infoWindow = new google.maps.InfoWindow({
                            content: infoContent
                        });
                        
                        marker.addListener('click', () => {
                            // Close any open info windows
                            fleetMarkers.forEach(m => {
                                if (m.infoWindow) m.infoWindow.close();
                            });
                            infoWindow.open(fleetMap, marker);
                        });
                        
                        // Store reference to info window
                        marker.infoWindow = infoWindow;
                        fleetMarkers.push(marker);
                    }
                });
                
                // Fit map to show all markers
                if (fleetMarkers.length > 0) {
                    const bounds = new google.maps.LatLngBounds();
                    fleetMarkers.forEach(marker => {
                        bounds.extend(marker.getPosition());
                    });
                    fleetMap.fitBounds(bounds);
                    
                    // Don't zoom in too much for single marker
                    if (fleetMarkers.length === 1) {
                        fleetMap.setZoom(14);
                    }
                }
            } catch (error) {
                console.error('Error loading vessel markers:', error);
            }
        }
        
        // Load Google Maps script
        async function loadGoogleMapsAndInitFleet() {
            // First, load the API key from server config
            if (!GOOGLE_MAPS_API_KEY) {
                try {
                    const response = await fetch('/api/config');
                    const config = await response.json();
                    GOOGLE_MAPS_API_KEY = config.googleMapsApiKey;
                    
                    if (!GOOGLE_MAPS_API_KEY) {
                        throw new Error('Google Maps API key not configured on server');
                    }
                } catch (error) {
                    console.error('Failed to load configuration:', error);
                    document.getElementById('fleetMap').innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">Map configuration error</div>';
                    return;
                }
            }
            
            if (window.google && window.google.maps) {
                // Google Maps already loaded
                initFleetMap();
            } else {
                // Create and load the Google Maps script
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initFleetMap&libraries=&v=weekly`;
                script.async = true;
                script.defer = true;
                script.onerror = function() {
                    console.error('Failed to load Google Maps. Please check API key and restrictions.');
                    document.getElementById('fleetMap').innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">Failed to load map</div>';
                };
                document.head.appendChild(script);
                
                // Make initFleetMap available globally for the callback
                window.initFleetMap = initFleetMap;
            }
        }
        
        // Delete announcement
        async function deleteAnnouncement(announcementId) {
            if (!confirm('Are you sure you want to delete this announcement?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/announcements/${announcementId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    loadAnnouncements(); // Reload the list
                } else {
                    alert('Failed to delete announcement: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting announcement:', error);
                alert('Failed to delete announcement');
            }
        }
        
        // Handle announcement form submission
        async function handleAnnouncementSubmit(event) {
            event.preventDefault();
            
            const title = document.getElementById('announcementTitle').value;
            const message = document.getElementById('announcementMessage').value;
            const sendSMS = confirm('Do you want to send this announcement as an SMS to all active roster staff?');
            
            // Use the stored current user email
            const userEmail = currentUserEmail;
            
            try {
                const response = await fetch('/api/announcements', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        title, 
                        message,
                        postedBy: userEmail,
                        sendSMS: sendSMS,
                        priority: 'Low' // Default priority
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let successMessage = 'Announcement posted successfully!';
                    if (sendSMS && result.sent) {
                        successMessage += `\nSMS sent to ${result.sent} staff members.`;
                        if (result.failed > 0) {
                            successMessage += `\n${result.failed} SMS messages failed.`;
                        }
                    }
                    alert(successMessage);
                    document.getElementById('announcementForm').reset();
                    loadAnnouncements(); // Reload the list
                } else {
                    alert('Failed to post announcement: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error posting announcement:', error);
                alert('Failed to post announcement');
            }
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            // Check authentication first
        checkAuth();
            
            // Animate sections on load
            const sections = document.querySelectorAll('.calendar-section, .fleet-section, .sidebar-section');
            sections.forEach((section, index) => {
                section.style.opacity = '0';
                section.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    section.style.transition = 'all 0.5s ease';
                    section.style.opacity = '1';
                    section.style.transform = 'translateY(0)';
                }, index * 100);
            });
            
            // Load Google Maps API and initialize map
            setTimeout(() => {
                loadGoogleMapsAndInitFleet();
            }, 500);
            
            // Update timestamps every minute
            setInterval(updateBookingTimestamps, 60000);
            
            // Removed simulated bookings - now using real data only
            
            // Add event listener for announcement form
            const announcementForm = document.getElementById('announcementForm');
            if (announcementForm) {
                announcementForm.addEventListener('submit', handleAnnouncementSubmit);
            }
        });
    </script>
</body>
</html>

