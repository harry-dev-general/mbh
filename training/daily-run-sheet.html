<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Run Sheet - MBH Staff Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f4f8;
            color: #333;
        }
        
        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #1B4F72 0%, #2E86AB 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 15px rgba(27, 79, 114, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 2rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .date-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }
        
        .date-controls button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.5rem;
            transition: background 0.2s;
            border-radius: 4px;
        }
        
        .date-controls button:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .date-controls input[type="date"] {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 1rem;
            color: #333;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #1B4F72;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1B4F72;
        }
        
        .stat-label {
            color: #666;
            margin-top: 0.5rem;
        }
        
        /* Timeline Section */
        .timeline-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow-x: auto;
        }
        
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .timeline-header h2 {
            color: #1B4F72;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .timeline-container {
            position: relative;
            min-width: 1200px;
        }
        
        .time-grid {
            display: grid;
            grid-template-columns: 150px repeat(14, 1fr);
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        
        .time-slot {
            text-align: center;
            font-weight: 600;
            color: #666;
            font-size: 0.9rem;
        }
        
        .vessel-row {
            display: grid;
            grid-template-columns: 150px repeat(14, 1fr);
            height: 100px;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
            position: relative;
            padding-bottom: 20px;
        }
        
        .vessel-name {
            font-weight: 600;
            padding: 0 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #333;
        }
        
        .booking-block {
            position: absolute;
            height: 75px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            color: white;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .booking-block:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 2;
        }
        
        .booking-block.preparing {
            background: linear-gradient(135deg, #FFC107 0%, #FFB300 100%);
        }
        
        .booking-block.on-water {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }
        
        .booking-block.returning {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }
        
        /* Allocation blocks for separate onboarding/deloading */
        .allocation-block {
            position: absolute;
            height: 60px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding: 0.4rem 0.6rem;
            color: white;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            white-space: nowrap;
            overflow: hidden;
            border: 2px solid transparent;
        }
        
        .allocation-block:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 2;
            cursor: pointer;
            filter: brightness(1.05);
        }
        
        /* Onboarding blocks */
        .allocation-block.onboarding-block {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }
        
        .allocation-block.onboarding-block.unstaffed {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            opacity: 0.6;
            border-color: #f44336;
        }
        
        /* Deloading blocks */
        .allocation-block.deloading-block {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }
        
        .allocation-block.deloading-block.unstaffed {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            opacity: 0.6;
            border-color: #f44336;
        }
        
        /* Current time indicator */
        .current-time-indicator {
            position: absolute;
            top: 40px;
            bottom: 0;
            width: 2px;
            background-color: #f44336;
            z-index: 10;
            pointer-events: none;
            transition: left 0.5s ease;
        }
        
        .current-time-indicator::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -4px;
            width: 10px;
            height: 10px;
            background-color: #f44336;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .current-time-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #f44336;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Time indicators for onboarding/deloading */
        .time-indicator {
            position: absolute;
            bottom: -20px;
            height: 20px;
            z-index: 3;
            cursor: pointer;
        }
        
        .time-indicator.onboarding .indicator-line {
            width: 2px;
            height: 20px;
            background-color: #4CAF50;
            margin: 0 auto;
        }
        
        .time-indicator.deloading .indicator-line {
            width: 2px;
            height: 20px;
            background-color: #f44336;
            margin: 0 auto;
        }
        
        .indicator-label {
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem;
            font-weight: 600;
            padding: 1px 4px;
            border-radius: 3px;
            white-space: nowrap;
        }
        
        .time-indicator.onboarding .indicator-label {
            background-color: #4CAF50;
            color: white;
        }
        
        .time-indicator.deloading .indicator-label {
            background-color: #f44336;
            color: white;
        }
        
        /* Vessel Status Section */
        .vessel-section {
            margin-bottom: 2rem;
        }
        
        .vessel-section h2 {
            color: #1B4F72;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .vessel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .vessel-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        
        .vessel-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .vessel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .vessel-name-card {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .status-ready {
            background: #E8F5E9;
            color: #2E7D32;
        }
        
        .status-preparing {
            background: #FFF8E1;
            color: #F57C00;
        }
        
        .status-on_water {
            background: #E3F2FD;
            color: #1565C0;
        }
        
        .status-returning {
            background: #FFF3E0;
            color: #E65100;
        }
        
        .status-maintenance {
            background: #FFEBEE;
            color: #C62828;
        }
        
        .vessel-details {
            display: grid;
            gap: 0.75rem;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }
        
        .detail-label {
            color: #666;
        }
        
        .detail-value {
            font-weight: 500;
        }
        
        /* Resource Gauges */
        .resource-gauges {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e0e0e0;
        }
        
        .gauge {
            text-align: center;
        }
        
        .gauge-label {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 0.25rem;
        }
        
        .gauge-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .gauge-fill {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s;
        }
        
        .gauge-fill.low {
            background: #f44336;
        }
        
        .gauge-fill.medium {
            background: #FF9800;
        }
        
        .gauge-value {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            font-weight: 600;
        }
        
        /* Add-ons Section */
        .addons-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .addons-header {
            color: #1B4F72;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .addons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        .addon-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .addon-item:hover {
            border-color: #1B4F72;
            background: #fff;
        }
        
        .addon-icon {
            font-size: 2rem;
        }
        
        .addon-details {
            flex: 1;
        }
        
        .addon-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .addon-count {
            color: #666;
            font-size: 0.9rem;
        }
        
        .addon-status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            background: #E8F5E9;
            color: #2E7D32;
        }
        
        /* Back Button */
        .back-button {
            background: white;
            color: #1B4F72;
            border: 2px solid #1B4F72;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .back-button:hover {
            background: #1B4F72;
            color: white;
        }
        
        /* Booking Details Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 1rem;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.5rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }
        
        .booking-detail-row {
            display: flex;
            margin-bottom: 1rem;
            align-items: flex-start;
        }
        
        .booking-detail-label {
            font-weight: 600;
            color: #666;
            min-width: 120px;
            margin-right: 1rem;
        }
        
        .booking-detail-value {
            color: #333;
            flex: 1;
        }
        
        .add-ons-list {
            margin-top: 0.5rem;
        }
        
        .add-on-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        
        .add-on-icon {
            font-size: 1.2rem;
            margin-right: 0.75rem;
        }
        
        .add-on-name {
            flex: 1;
            font-weight: 500;
        }
        
        .add-on-price {
            color: #666;
            font-size: 0.9rem;
        }
        
        .no-addons {
            color: #999;
            font-style: italic;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .container {
                padding: 1rem;
            }
            
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .vessel-grid {
                grid-template-columns: 1fr;
            }
            
            .addons-grid {
                grid-template-columns: 1fr;
            }
            
            .timeline-section {
                padding: 1rem;
            }
        }
        
        /* Error Message */
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* No Data Message */
        .no-data {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .no-data i {
            font-size: 3rem;
            color: #ccc;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <!-- Header -->
    <div class="header">
        <h1><i class="fas fa-clipboard-list"></i> Daily Run Sheet</h1>
        <div class="date-controls">
            <button id="prevDay" title="Previous Day">
                <i class="fas fa-chevron-left"></i>
            </button>
            <input type="date" id="dateInput">
            <button id="nextDay" title="Next Day">
                <i class="fas fa-chevron-right"></i>
            </button>
            <button id="todayBtn" style="background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 4px;">
                Today
            </button>
            <button id="jumpToBookingsBtn" style="background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 4px; margin-left: 10px;" title="Jump to next booking date">
                <i class="fas fa-calendar-check"></i> Next Bookings
            </button>
        </div>
    </div>
    
    <!-- Main Container -->
    <div class="container">
        <!-- Back Button -->
        <a href="management-dashboard.html" class="back-button" style="margin-bottom: 2rem;">
            <i class="fas fa-arrow-left"></i> Back to Management Dashboard
        </a>
        
        <!-- Stats Bar -->
        <div id="statsContainer" class="stats-bar"></div>
        
        <!-- Timeline Section -->
        <div id="timelineSection" class="timeline-section"></div>
        
        <!-- Vessel Status Section -->
        <div class="vessel-section">
            <h2><i class="fas fa-anchor"></i> Fleet Status</h2>
            <div id="vesselGrid" class="vessel-grid"></div>
        </div>
        
        <!-- Add-ons Section -->
        <div id="addonsSection" class="addons-section"></div>
    </div>
    
    <!-- Booking Details Modal -->
    <div id="bookingModal" class="modal-overlay" onclick="closeBookingModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modalTitle">Booking Details</h3>
                <button class="modal-close" onclick="closeBookingModal()">×</button>
            </div>
            <div id="modalBody">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
    </div>
    
    <script>
        // Supabase initialization
        const SUPABASE_URL = 'https://etkugeooigiwahikrmzr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0a3VnZW9vaWdpd2FoaWtybXpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4MDI0OTcsImV4cCI6MjA2ODM3ODQ5N30.OPIYLsnPNNF7dP3SDCODIurzaa3X_Q3xEhfPO3rLJxU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // State management
        const today = new Date();
        let currentDate = today.toISOString().split('T')[0];
        let runSheetData = null;
        let currentUser = null;
        let nextBookingDate = null;
        
        // Find next booking date from Airtable
        async function findNextBookingDate() {
            try {
                // Query Airtable directly for upcoming bookings
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(
                    `/api/airtable/applkAFOn2qxtu7tx/tblRe0cDmK3bG2kPf?` +
                    `filterByFormula=${encodeURIComponent(`AND({Booking Date} > '${today}', OR({Status}='PAID', {Status}='PART'))`)}&` +
                    `fields[]=Booking Date&` +
                    `sort[0][field]=Booking Date&` +
                    `sort[0][direction]=asc&` +
                    `maxRecords=1`
                );
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.records && data.records.length > 0) {
                        nextBookingDate = data.records[0].fields['Booking Date'];
                        updateJumpToButton();
                    }
                }
            } catch (error) {
                console.error('Error finding next booking date:', error);
            }
        }
        
        // Update Jump To button text
        function updateJumpToButton() {
            const button = document.getElementById('jumpToBookingsBtn');
            if (button && nextBookingDate) {
                const [year, month, day] = nextBookingDate.split('-').map(Number);
                const date = new Date(year, month - 1, day); // month is 0-indexed
                const formatter = new Intl.DateTimeFormat('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric',
                    timeZone: 'Australia/Sydney'
                });
                const formattedDate = formatter.format(date);
                button.innerHTML = `<i class="fas fa-calendar-check"></i> Jump to ${formattedDate}`;
            }
        }
        
        // Check authentication
        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = 'auth.html';
                return;
            }
            currentUser = user;
            
            // Set up date controls
            setupDateControls();
            
            // Load initial data and find next booking
            await Promise.all([
                loadDailyRunSheet(),
                findNextBookingDate()
            ]);
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
        });
        
        // Clean up interval on page unload
        window.addEventListener('beforeunload', () => {
            if (window.timeIndicatorInterval) {
                clearInterval(window.timeIndicatorInterval);
            }
        });
        
        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeBookingModal();
            }
        });
        
        // Set up date controls
        function setupDateControls() {
            const dateInput = document.getElementById('dateInput');
            dateInput.value = currentDate;
            
            // Previous day
            document.getElementById('prevDay').addEventListener('click', () => {
                const date = new Date(currentDate);
                date.setDate(date.getDate() - 1);
                currentDate = date.toISOString().split('T')[0];
                dateInput.value = currentDate;
                loadDailyRunSheet();
            });
            
            // Next day
            document.getElementById('nextDay').addEventListener('click', () => {
                const date = new Date(currentDate);
                date.setDate(date.getDate() + 1);
                currentDate = date.toISOString().split('T')[0];
                dateInput.value = currentDate;
                loadDailyRunSheet();
            });
            
            // Today button
            document.getElementById('todayBtn').addEventListener('click', () => {
                const today = new Date();
                currentDate = today.toISOString().split('T')[0];
                dateInput.value = currentDate;
                loadDailyRunSheet();
            });
            
            // Date input change
            dateInput.addEventListener('change', (e) => {
                currentDate = e.target.value;
                loadDailyRunSheet();
            });
            
            // Jump to latest bookings button
            document.getElementById('jumpToBookingsBtn').addEventListener('click', () => {
                if (nextBookingDate) {
                    navigateToDate(nextBookingDate);
                } else {
                    // If no next booking found, try to find it again
                    findNextBookingDate();
                }
            });
        }
        
        // Load daily run sheet data
        async function loadDailyRunSheet() {
            document.getElementById('loading').style.display = 'flex';
            
            try {
                const response = await fetch(`/api/daily-run-sheet?date=${currentDate}`);
                if (!response.ok) throw new Error('Failed to load data');
                
                runSheetData = await response.json();
                
                if (runSheetData.success) {
                    renderStats();
                    renderTimeline();
                    renderVesselStatus();
                    renderAddOns();
                } else {
                    showError(runSheetData.error || 'Failed to load daily run sheet');
                }
            } catch (error) {
                console.error('Error loading daily run sheet:', error);
                showError('Failed to load daily run sheet. Please try again.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // Render statistics
        function renderStats() {
            const container = document.getElementById('statsContainer');
            const { stats } = runSheetData;
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.totalBookings}</div>
                    <div class="stat-label">Total Bookings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.onWater}</div>
                    <div class="stat-label">On Water Now</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.preparing}</div>
                    <div class="stat-label">Preparing</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.returning}</div>
                    <div class="stat-label">Returning Soon</div>
                </div>
            `;
        }
        
        // Render timeline view
        function renderTimeline() {
            const section = document.getElementById('timelineSection');
            const { bookings } = runSheetData;
            
            if (!bookings || bookings.length === 0) {
                let emptyStateHTML = `
                    <div class="no-data">
                        <i class="fas fa-calendar-times"></i>
                        <p>No bookings scheduled for ${formatDate(currentDate)}</p>
                        <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                            Try navigating to a different date using the date controls above.
                        </p>
                `;
                
                if (nextBookingDate) {
                    const [year, month, day] = nextBookingDate.split('-').map(Number);
                    const nextDate = new Date(year, month - 1, day); // month is 0-indexed
                    const formatter = new Intl.DateTimeFormat('en-US', { 
                        weekday: 'long', 
                        month: 'short', 
                        day: 'numeric',
                        timeZone: 'Australia/Sydney'
                    });
                    const formattedDate = formatter.format(nextDate);
                    
                    emptyStateHTML += `
                        <p style="font-size: 0.85em; color: #999; margin-top: 5px;">
                            Next booking is scheduled for ${formattedDate}.
                        </p>
                        <button onclick="navigateToDate('${nextBookingDate}')" style="margin-top: 15px; padding: 10px 20px; background: white; color: #1B4F72; border: 2px solid #1B4F72; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 0.9rem;"
                                onmouseover="this.style.background='#1B4F72'; this.style.color='white';"
                                onmouseout="this.style.background='white'; this.style.color='#1B4F72';">
                            <i class="fas fa-calendar-day"></i> Jump to ${formattedDate}
                        </button>
                    `;
                }
                
                emptyStateHTML += `</div>`;
                section.innerHTML = emptyStateHTML;
                return;
            }
            
            // Group bookings by vessel
            const vesselBookings = {};
            bookings.forEach(booking => {
                const vesselName = booking.vesselName || 'Unassigned';
                if (!vesselBookings[vesselName]) {
                    vesselBookings[vesselName] = [];
                }
                vesselBookings[vesselName].push(booking);
            });
            
            // Create timeline HTML
            let timelineHtml = `
                <div class="timeline-header">
                    <h2><i class="fas fa-calendar-alt"></i> Booking Timeline</h2>
                </div>
                <div class="timeline-container">
                    <div class="time-grid">
                        <div class="time-slot">Vessel</div>
            `;
            
            // Add time headers (6 AM to 8 PM)
            for (let hour = 6; hour <= 20; hour++) {
                const displayHour = hour > 12 ? hour - 12 : hour;
                const ampm = hour >= 12 ? 'PM' : 'AM';
                timelineHtml += `<div class="time-slot">${displayHour} ${ampm}</div>`;
            }
            
            timelineHtml += '</div>';
            
            // Add vessel rows
            Object.entries(vesselBookings).forEach(([vesselName, bookings]) => {
                timelineHtml += `
                    <div class="vessel-row">
                        <div class="vessel-name">
                            <i class="fas fa-ship"></i> ${vesselName}
                        </div>
                `;
                
                // Add booking blocks - create separate blocks for onboarding and deloading
                bookings.forEach(booking => {
                    // Create onboarding block
                    if (booking.onboardingTime) {
                        const onboardingBlock = createAllocationBlock(booking, 'onboarding');
                        timelineHtml += onboardingBlock;
                    }
                    
                    // Create deloading block (only if different from onboarding time)
                    if (booking.deloadingTime && booking.deloadingTime !== booking.onboardingTime) {
                        const deloadingBlock = createAllocationBlock(booking, 'deloading');
                        timelineHtml += deloadingBlock;
                    }
                });
                
                timelineHtml += '</div>';
            });
            
            timelineHtml += '</div>';
            section.innerHTML = timelineHtml;
            
            // Add current time indicator
            addCurrentTimeIndicator();
        }
        
        // Create allocation block for timeline (separate for onboarding/deloading)
        function createAllocationBlock(booking, type) {
            // Determine which time to use based on type
            const time = type === 'onboarding' ? booking.onboardingTime : booking.deloadingTime;
            const staffName = type === 'onboarding' ? booking.onboardingStaffName : booking.deloadingStaffName;
            
            if (!time) return '';
            
            const parsedTime = parseTime(time);
            const hour = parsedTime.getHours() + (parsedTime.getMinutes() / 60);
            const left = 150 + ((hour - 6) * 85);
            const width = 75; // Fixed width for allocation blocks
            
            // Determine status
            const hasStaff = staffName && staffName !== 'Unassigned';
            const statusClass = hasStaff ? 'staffed' : 'unstaffed';
            
            // Type indicator
            const typeLabel = type === 'onboarding' ? '🚢 ON' : '🏁 OFF';
            const typeColorClass = type === 'onboarding' ? 'onboarding-block' : 'deloading-block';
            
            // Get add-on icons only for onboarding
            const addOnIcons = type === 'onboarding' ? getAddOnIcons(booking.addOns) : '';
            
            return `
                <div class="allocation-block ${typeColorClass} ${statusClass}" 
                     style="left: ${left}px; width: ${width}px;"
                     title="${booking.customerName} - ${type === 'onboarding' ? 'Onboarding' : 'Deloading'} at ${time}"
                     onclick='showBookingDetails(${JSON.stringify(booking).replace(/'/g, "&apos;")}, "${type}")'>
                    <div style="display: flex; flex-direction: column; gap: 0.2rem;">
                        <div style="font-weight: 600; font-size: 0.75rem; display: flex; align-items: center; gap: 0.3rem;">
                            <span>${typeLabel}</span>
                        </div>
                        <div style="font-size: 0.7rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${booking.customerName}
                        </div>
                        <div style="font-size: 0.65rem; opacity: 0.9; display: flex; align-items: center; gap: 0.2rem;">
                            <i class="fas ${hasStaff ? 'fa-user-check' : 'fa-user-times'}" style="font-size: 0.6rem;"></i>
                            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${staffName}</span>
                            ${addOnIcons}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Create booking block for timeline (keeping for compatibility)
        function createBookingBlock(booking) {
            const startTime = parseTime(booking.startTime);
            const duration = booking.duration || 4;
            
            // Calculate position (6 AM = 0, each hour = 85px + grid gap)
            const startHour = startTime.getHours() + (startTime.getMinutes() / 60);
            const left = 150 + ((startHour - 6) * 85);
            const width = duration * 85 - 10; // -10 for padding
            
            // Determine status class
            const vessel = runSheetData.vessels.find(v => v.id === booking.vesselId);
            const statusClass = vessel ? vessel.status.replace('_', '-') : '';
            
            // Get add-on icons
            const addOnIcons = getAddOnIcons(booking.addOns);
            
            // Format onboarding and deloading times
            const onboardingTimeStr = booking.onboardingTime || 'TBA';
            const deloadingTimeStr = booking.deloadingTime || 'TBA';
            
            // Create onboarding and deloading indicators
            let timeIndicators = '';
            if (booking.onboardingTime) {
                const onboardTime = parseTime(booking.onboardingTime);
                const onboardHour = onboardTime.getHours() + (onboardTime.getMinutes() / 60);
                const onboardLeft = ((onboardHour - 6) * 85) - left;
                timeIndicators += `
                    <div class="time-indicator onboarding" style="left: ${onboardLeft}px;" 
                         title="Onboarding: ${onboardingTimeStr} - ${booking.onboardingStaffName}">
                        <div class="indicator-line"></div>
                        <div class="indicator-label">ON</div>
                    </div>
                `;
            }
            
            if (booking.deloadingTime) {
                const deloadTime = parseTime(booking.deloadingTime);
                const deloadHour = deloadTime.getHours() + (deloadTime.getMinutes() / 60);
                const deloadLeft = ((deloadHour - 6) * 85) - left;
                timeIndicators += `
                    <div class="time-indicator deloading" style="left: ${deloadLeft}px;"
                         title="Deloading: ${deloadingTimeStr} - ${booking.deloadingStaffName}">
                        <div class="indicator-line"></div>
                        <div class="indicator-label">OFF</div>
                    </div>
                `;
            }
            
            return `
                <div class="booking-block ${statusClass}" 
                     style="left: ${left}px; width: ${width}px;"
                     title="${booking.customerName} - ${booking.startTime} to ${booking.finishTime}">
                    <div style="display: flex; flex-direction: column; gap: 0.25rem; position: relative;">
                        <div style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${booking.customerName}
                        </div>
                        <div style="font-size: 0.7rem; opacity: 0.9; display: flex; flex-direction: column; gap: 0.2rem;">
                            <div style="display: flex; align-items: center; gap: 0.3rem;">
                                <i class="fas fa-user-check" style="font-size: 0.65rem;"></i>
                                <span>${booking.onboardingStaffName}</span>
                                ${addOnIcons}
                            </div>
                            ${booking.deloadingStaffName !== booking.onboardingStaffName ? `
                                <div style="display: flex; align-items: center; gap: 0.3rem;">
                                    <i class="fas fa-user-times" style="font-size: 0.65rem;"></i>
                                    <span>${booking.deloadingStaffName}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ${timeIndicators}
                </div>
            `;
        }
        
        // Render vessel status cards
        function renderVesselStatus() {
            const grid = document.getElementById('vesselGrid');
            const { vessels } = runSheetData;
            
            if (!vessels || vessels.length === 0) {
                grid.innerHTML = '<p class="no-data">No vessel data available</p>';
                return;
            }
            
            grid.innerHTML = vessels.map(vessel => {
                const statusBadgeClass = `status-${vessel.status}`;
                const statusText = formatStatus(vessel.status);
                
                // Get current booking for vessel
                const currentBooking = runSheetData.bookings.find(b => 
                    b.vesselId === vessel.id && vessel.status === 'on_water'
                );
                
                return `
                    <div class="vessel-card">
                        <div class="vessel-header">
                            <div class="vessel-name-card">
                                <i class="fas fa-ship"></i> ${vessel.name}
                            </div>
                            <div class="status-badge ${statusBadgeClass}">
                                ${statusText}
                            </div>
                        </div>
                        <div class="vessel-details">
                            ${currentBooking ? `
                                <div class="detail-row">
                                    <span class="detail-label">Booking:</span>
                                    <span class="detail-value">${currentBooking.bookingCode}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Customer:</span>
                                    <span class="detail-value">${currentBooking.customerName}</span>
                                </div>
                            ` : ''}
                            ${vessel.departureTime ? `
                                <div class="detail-row">
                                    <span class="detail-label">Departed:</span>
                                    <span class="detail-value">${formatTime(vessel.departureTime)}</span>
                                </div>
                            ` : ''}
                            ${vessel.returnTime ? `
                                <div class="detail-row">
                                    <span class="detail-label">Returned:</span>
                                    <span class="detail-value">${formatTime(vessel.returnTime)}</span>
                                </div>
                            ` : ''}
                            ${vessel.location ? `
                                <div class="detail-row">
                                    <span class="detail-label">Location:</span>
                                    <span class="detail-value">📍 ${vessel.location.address || 'GPS Captured'}</span>
                                </div>
                            ` : ''}
                        </div>
                        ${renderResourceGauges(vessel)}
                    </div>
                `;
            }).join('');
        }
        
        // Render resource gauges
        function renderResourceGauges(vessel) {
            const fuelPercentage = levelToPercentage(vessel.fuelLevel);
            const gasPercentage = levelToPercentage(vessel.gasLevel);
            const waterPercentage = levelToPercentage(vessel.waterLevel);
            
            return `
                <div class="resource-gauges">
                    ${renderGauge('Fuel', fuelPercentage)}
                    ${renderGauge('Gas', gasPercentage)}
                    ${renderGauge('Water', waterPercentage)}
                </div>
            `;
        }
        
        // Render individual gauge
        function renderGauge(label, percentage) {
            const fillClass = percentage < 25 ? 'low' : percentage < 50 ? 'medium' : '';
            
            return `
                <div class="gauge">
                    <div class="gauge-label">${label}</div>
                    <div class="gauge-bar">
                        <div class="gauge-fill ${fillClass}" style="width: ${percentage}%;"></div>
                    </div>
                    <div class="gauge-value">${percentage}%</div>
                </div>
            `;
        }
        
        // Render add-ons section
        function renderAddOns() {
            const section = document.getElementById('addonsSection');
            const { addOnsSummary } = runSheetData;
            
            if (!addOnsSummary || Object.keys(addOnsSummary).length === 0) {
                section.innerHTML = `
                    <h2 class="addons-header">
                        <i class="fas fa-box"></i> Today's Add-ons Required
                    </h2>
                    <p class="no-data">No add-ons required for today</p>
                `;
                return;
            }
            
            let addOnsHtml = `
                <h2 class="addons-header">
                    <i class="fas fa-box"></i> Today's Add-ons Required
                </h2>
                <div class="addons-grid">
            `;
            
            Object.entries(addOnsSummary).forEach(([item, count]) => {
                const icon = getAddOnIcon(item);
                addOnsHtml += `
                    <div class="addon-item">
                        <div class="addon-icon">${icon}</div>
                        <div class="addon-details">
                            <div class="addon-name">${item}</div>
                            <div class="addon-count">${count} needed</div>
                        </div>
                        <div class="addon-status">Preparing</div>
                    </div>
                `;
            });
            
            addOnsHtml += '</div>';
            section.innerHTML = addOnsHtml;
        }
        
        // Helper functions
        function parseTime(timeStr) {
            if (!timeStr) return new Date();
            
            // Handle various time formats
            const now = new Date();
            const timeParts = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
            
            if (timeParts) {
                let hours = parseInt(timeParts[1]);
                const minutes = parseInt(timeParts[2]);
                const ampm = timeParts[3];
                
                if (ampm) {
                    if (ampm.toUpperCase() === 'PM' && hours !== 12) hours += 12;
                    if (ampm.toUpperCase() === 'AM' && hours === 12) hours = 0;
                }
                
                now.setHours(hours, minutes, 0, 0);
                return now;
            }
            
            return new Date();
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-AU', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
        
        function formatTime(timeStr) {
            const date = new Date(timeStr);
            return date.toLocaleTimeString('en-AU', { 
                hour: 'numeric', 
                minute: '2-digit' 
            });
        }
        
        function formatStatus(status) {
            const statusMap = {
                'ready': 'Ready',
                'preparing': 'Preparing',
                'on_water': 'On Water',
                'returning': 'Returning',
                'maintenance': 'Maintenance',
                'unknown': 'Unknown'
            };
            return statusMap[status] || status;
        }
        
        function levelToPercentage(level) {
            const levelMap = {
                'Empty': 0,
                'Quarter': 25,
                'Half': 50,
                'Three-Quarter': 75,
                'Full': 100
            };
            return levelMap[level] || 0;
        }
        
        function getAddOnIcon(item) {
            const iconMap = {
                'Fishing Rods': '🎣',
                'Fishing Rod': '🎣',
                'Ice Bags': '🧊',
                'Icebag': '🧊',
                'Icebags': '🧊',
                'Lilly Pad': '🏖️',
                'Lilly Pads': '🏖️',
                'BBQ Pack': '🍖',
                'BBQ Equipment': '🍖',
                'Extra Life Jackets': '🦺',
                'Child Life Jacket': '🦺',
                'Bluetooth Speaker': '📻'
            };
            return iconMap[item] || '📦';
        }
        
        function getAddOnIcons(addOnsStr) {
            if (!addOnsStr) return '';
            
            const icons = [];
            const addOnsList = addOnsStr.split(',').map(a => a.trim());
            
            addOnsList.forEach(addon => {
                const itemName = addon.split(' - ')[0].trim();
                const icon = getAddOnIcon(itemName);
                if (icon && !icons.includes(icon)) {
                    icons.push(icon);
                }
            });
            
            return icons.join(' ');
        }
        
        // Navigate to a specific date
        function navigateToDate(dateString) {
            currentDate = dateString;
            document.getElementById('dateInput').value = dateString;
            loadDailyRunSheet();
        }
        
        // Add current time indicator to timeline
        function addCurrentTimeIndicator() {
            const timelineContainer = document.querySelector('.timeline-container');
            if (!timelineContainer) return;
            
            // Create indicator element
            const indicator = document.createElement('div');
            indicator.className = 'current-time-indicator';
            indicator.innerHTML = '<div class="current-time-label"></div>';
            
            // Add to timeline
            timelineContainer.appendChild(indicator);
            
            // Update position immediately
            updateCurrentTimeIndicator();
            
            // Update every minute
            if (window.timeIndicatorInterval) {
                clearInterval(window.timeIndicatorInterval);
            }
            window.timeIndicatorInterval = setInterval(updateCurrentTimeIndicator, 60000);
        }
        
        // Update current time indicator position
        function updateCurrentTimeIndicator() {
            const indicator = document.querySelector('.current-time-indicator');
            if (!indicator) return;
            
            // Get current time in Sydney timezone
            const now = new Date();
            // For the 2025 context, we'll use the actual current time but in the context date
            const contextDate = new Date(currentDate);
            now.setFullYear(contextDate.getFullYear());
            now.setMonth(contextDate.getMonth());
            now.setDate(contextDate.getDate());
            
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const totalHours = hours + (minutes / 60);
            
            // Check if current time is within timeline bounds (6 AM to 8 PM)
            if (totalHours < 6 || totalHours > 20) {
                indicator.style.display = 'none';
                return;
            }
            
            indicator.style.display = 'block';
            
            // Calculate position (6 AM = 0, each hour = 85px)
            const hoursFromStart = totalHours - 6;
            const left = 150 + (hoursFromStart * 85); // 150px for vessel name column
            
            indicator.style.left = `${left}px`;
            
            // Update time label
            const label = indicator.querySelector('.current-time-label');
            const timeString = now.toLocaleTimeString('en-AU', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
            label.textContent = timeString;
        }
        
        function showError(message) {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <a href="management-dashboard.html" class="back-button" style="margin-bottom: 2rem;">
                    <i class="fas fa-arrow-left"></i> Back to Management Dashboard
                </a>
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    ${message}
                </div>
            `;
        }
        
        // Show booking details modal
        function showBookingDetails(booking, allocationType) {
            const modal = document.getElementById('bookingModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalTitle');
            
            // Set title
            modalTitle.textContent = `${booking.customerName} - ${booking.bookingCode}`;
            
            // Parse add-ons
            let addOnsHtml = '<div class="no-addons">No add-ons for this booking</div>';
            if (booking.addOns) {
                const addOnsList = booking.addOns.split(',').map(item => item.trim());
                if (addOnsList.length > 0 && addOnsList[0] !== '') {
                    addOnsHtml = '<div class="add-ons-list">';
                    addOnsList.forEach(addon => {
                        const [name, price] = addon.split(' - ');
                        const icon = getAddOnIcon(name);
                        addOnsHtml += `
                            <div class="add-on-item">
                                <span class="add-on-icon">${icon}</span>
                                <span class="add-on-name">${name}</span>
                                <span class="add-on-price">${price || ''}</span>
                            </div>
                        `;
                    });
                    addOnsHtml += '</div>';
                }
            }
            
            // Build modal content
            const content = `
                <div class="booking-detail-row">
                    <div class="booking-detail-label">Booking Code:</div>
                    <div class="booking-detail-value">${booking.bookingCode}</div>
                </div>
                <div class="booking-detail-row">
                    <div class="booking-detail-label">Customer:</div>
                    <div class="booking-detail-value">${booking.customerName}</div>
                </div>
                <div class="booking-detail-row">
                    <div class="booking-detail-label">Vessel:</div>
                    <div class="booking-detail-value">${booking.vesselName}</div>
                </div>
                <div class="booking-detail-row">
                    <div class="booking-detail-label">Duration:</div>
                    <div class="booking-detail-value">${booking.duration} hours (${booking.startTime} - ${booking.finishTime})</div>
                </div>
                <div class="booking-detail-row">
                    <div class="booking-detail-label">Onboarding:</div>
                    <div class="booking-detail-value">
                        ${booking.onboardingTime || 'Not scheduled'} 
                        ${booking.onboardingTime ? `- ${booking.onboardingStaffName}` : ''}
                    </div>
                </div>
                <div class="booking-detail-row">
                    <div class="booking-detail-label">Deloading:</div>
                    <div class="booking-detail-value">
                        ${booking.deloadingTime || 'Not scheduled'} 
                        ${booking.deloadingTime ? `- ${booking.deloadingStaffName}` : ''}
                    </div>
                </div>
                <div class="booking-detail-row">
                    <div class="booking-detail-label">Total Amount:</div>
                    <div class="booking-detail-value">$${booking.totalAmount ? booking.totalAmount.toFixed(2) : '0.00'}</div>
                </div>
                <div class="booking-detail-row">
                    <div class="booking-detail-label">Status:</div>
                    <div class="booking-detail-value">${booking.status || 'Unknown'}</div>
                </div>
                <div class="booking-detail-row">
                    <div class="booking-detail-label">Add-ons:</div>
                    <div class="booking-detail-value">${addOnsHtml}</div>
                </div>
            `;
            
            modalBody.innerHTML = content;
            modal.classList.add('active');
        }
        
        // Close booking modal
        function closeBookingModal(event) {
            if (!event || event.target.id === 'bookingModal') {
                const modal = document.getElementById('bookingModal');
                modal.classList.remove('active');
            }
        }
    </script>
</body>
</html>
