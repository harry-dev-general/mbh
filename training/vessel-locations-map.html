<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manly Boat Hire - Vessel Locations Map</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f4f8;
            color: #333;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #1B4F72 0%, #2E86AB 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 100px);
            position: relative;
        }
        
        .sidebar {
            width: 350px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            z-index: 10;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .location-card {
            padding: 1.5rem;
            border-bottom: 1px solid #E5E7E9;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .location-card:hover {
            background: #F8F9F9;
        }
        
        .location-card.active {
            background: #EBF5FB;
            border-left: 4px solid #3498DB;
        }
        
        .location-card h3 {
            color: #2E86AB;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }
        
        .location-card h3 i {
            margin-right: 0.5rem;
        }
        
        .vessel-info {
            background: #F8F9F9;
            padding: 0.5rem;
            border-radius: 5px;
            margin: 0.5rem 0;
        }
        
        .vessel-info strong {
            color: #2874A6;
        }
        
        .access-details {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        .access-details li {
            margin: 0.25rem 0;
            padding-left: 1rem;
        }
        
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 5;
        }
        
        .legend h4 {
            color: #2E86AB;
            margin-bottom: 0.5rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 0.5rem 0;
        }
        
        .legend-icon {
            width: 30px;
            height: 30px;
            margin-right: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
            font-weight: bold;
        }
        
        .swing-mooring {
            background: #3498DB;
        }
        
        .marina-berth {
            background: #27AE60;
        }
        
        .temp-mooring {
            background: #F39C12;
        }
        
        .directions-btn {
            background: #2E86AB;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 0.5rem;
            width: 100%;
            transition: background 0.3s;
        }
        
        .directions-btn:hover {
            background: #1B4F72;
        }
        
        .back-btn {
            position: absolute;
            top: 20px;
            left: 370px;
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-decoration: none;
            color: #2E86AB;
            z-index: 10;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: #2E86AB;
            color: white;
        }
        
        .api-key-notice {
            background: #FCF3CF;
            border: 2px solid #F39C12;
            padding: 1rem;
            margin: 1rem;
            border-radius: 5px;
            text-align: center;
        }
        
        .api-key-notice h3 {
            color: #D68910;
            margin-bottom: 0.5rem;
        }
        
        .api-key-notice code {
            background: #FEF9E7;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 40vh;
                order: 2;
            }
            
            .map-container {
                height: 60vh;
                order: 1;
            }
            
            .back-btn {
                left: 20px;
            }
            
            .legend {
                bottom: auto;
                top: 70px;
                left: 10px;
                font-size: 0.8rem;
            }
        }
        
        /* Custom map info window styles */
        .info-window {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 300px;
        }
        
        .info-window h3 {
            color: #2E86AB;
            margin-bottom: 0.5rem;
        }
        
        .info-window .vessel-name {
            background: #EBF5FB;
            padding: 0.3rem 0.5rem;
            border-radius: 3px;
            margin: 0.3rem 0;
            font-weight: bold;
        }
        
        .info-window .detail {
            margin: 0.2rem 0;
            font-size: 0.9rem;
        }
        
        /* View toggle styles */
        .view-toggle {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 0.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10;
            display: flex;
            gap: 0.5rem;
        }
        
        .toggle-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: #E5E7E9;
            color: #333;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .toggle-btn.active {
            background: #2E86AB;
            color: white;
        }
        
        .toggle-btn:hover:not(.active) {
            background: #D5D8DC;
        }
        
        .anchorage-legend {
            display: none;
        }
        
        .anchorage-legend.active {
            display: block;
        }
        
        .vessel-legend {
            display: block;
        }
        
        .vessel-legend.hidden {
            display: none;
        }
        
        /* New vessel-centric sidebar styles */
        .vessel-card {
            padding: 1.5rem;
            border-bottom: 1px solid #E5E7E9;
            cursor: pointer;
            transition: background 0.3s;
            position: relative;
        }
        
        .vessel-card:hover {
            background: #F8F9F9;
        }
        
        .vessel-card h3 {
            color: #2E86AB;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .vessel-status {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ddd;
        }
        
        .vessel-status.has-location {
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }
        
        .vessel-location {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .vessel-mooring {
            font-size: 0.85rem;
            color: #888;
            background: #EBF5FB;
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            display: inline-block;
            margin-top: 0.5rem;
        }
        
        .sidebar-header {
            background: #2E86AB;
            color: white;
            padding: 1rem;
            margin: -1rem -1rem 1rem -1rem;
            text-align: center;
            font-weight: bold;
        }
        
        .no-vessels {
            text-align: center;
            color: #666;
            padding: 2rem;
            font-style: italic;
        }
        
        .loading-vessels {
            text-align: center;
            color: #666;
            padding: 2rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .view-toggle {
                top: 60px;
                font-size: 0.9rem;
            }
            
            .toggle-btn {
                padding: 0.4rem 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-map-marked-alt"></i> Vessel Locations & Safe Anchorages</h1>
        <p>Interactive map showing vessel storage locations and safe anchorage areas</p>
    </div>
    
    <a href="dashboard.html" class="back-btn">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>
    
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-ship"></i> Fleet Status
            </div>
            <div id="vesselList" class="vessel-list">
                <div class="loading-vessels">
                    <i class="fas fa-spinner fa-spin"></i> Loading vessel data...
                </div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map">
                <div class="api-key-notice">
                    <h3><i class="fas fa-key"></i> Google Maps API Key Required</h3>
                    <p>To enable the interactive map, please add your Google Maps API key:</p>
                    <ol style="text-align: left; max-width: 500px; margin: 1rem auto;">
                        <li>Get an API key from <a href="https://console.cloud.google.com/google/maps-apis/" target="_blank">Google Cloud Console</a></li>
                        <li>Enable the Maps JavaScript API</li>
                        <li>Replace <code>YOUR_API_KEY</code> at the bottom of this HTML file</li>
                    </ol>
                    <p><strong>Alternative:</strong> Use the "Get Directions" buttons for Google Maps navigation</p>
                </div>
            </div>
            
            <div class="view-toggle">
                <button class="toggle-btn active" onclick="showVesselView()">
                    <i class="fas fa-ship"></i> Vessel Locations
                </button>
                <button class="toggle-btn" onclick="showAnchorageView()">
                    <i class="fas fa-anchor"></i> Safe Anchorages
                </button>
                <button class="toggle-btn" onclick="fetchVesselData()" style="background: #28a745;">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
            
            <div class="legend vessel-legend">
                <h4>Location Types</h4>
                <div class="legend-item">
                    <div class="legend-icon swing-mooring">
                        <i class="fas fa-anchor"></i>
                    </div>
                    <span>Swing Mooring</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon marina-berth">
                        <i class="fas fa-building"></i>
                    </div>
                    <span>Marina Berth</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon temp-mooring">
                        <i class="fas fa-clock"></i>
                    </div>
                    <span>Temporary Mooring</span>
                </div>
                <hr style="margin: 10px 0;">
                <div class="legend-item">
                    <div class="legend-icon" style="background: #FF0000;">
                        <i class="fas fa-circle" style="font-size: 0.8em;"></i>
                    </div>
                    <span>Current Location</span>
                </div>
                <p style="font-size: 0.8em; color: #666; margin-top: 5px;">
                    Updated from checklists
                </p>
            </div>
            
            <div class="legend anchorage-legend">
                <h4>Safe Anchorages</h4>
                <p style="font-size: 0.9rem; margin-bottom: 0.5rem;">Protected from S/SE winds</p>
                <ul style="list-style: none; padding: 0;">
                    <li style="margin: 0.3rem 0;"><i class="fas fa-circle" style="color: #E74C3C; opacity: 0.6;"></i> Forty Baskets Beach</li>
                    <li style="margin: 0.3rem 0;"><i class="fas fa-circle" style="color: #E74C3C; opacity: 0.6;"></i> Collins Beach</li>
                    <li style="margin: 0.3rem 0;"><i class="fas fa-circle" style="color: #E74C3C; opacity: 0.6;"></i> Store Beach</li>
                    <li style="margin: 0.3rem 0;"><i class="fas fa-circle" style="color: #E74C3C; opacity: 0.6;"></i> Quarantine Beach</li>
                </ul>
                <div class="alert" style="background: #FEF9E7; border-left: 3px solid #F39C12; padding: 0.5rem; margin-top: 0.5rem; font-size: 0.85rem;">
                    <i class="fas fa-exclamation-triangle" style="color: #D68910;"></i> Use when wind exceeds 20kts from S/SE
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://etkugeooigiwahikrmzr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0a3VnZW9vaWdpd2FoaWtybXpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4MDI0OTcsImV4cCI6MjA2ODM3ODQ5N30.OPIYLsnPNNF7dP3SDCODIurzaa3X_Q3xEhfPO3rLJxU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Check authentication on page load
        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                // Redirect to login page if not authenticated
                window.location.href = 'auth.html';
            }
        }

        // Run auth check when page loads
        checkAuth();

        let map;
        let markers = {};
        let infoWindows = {};
        let anchorageCircles = [];
        let currentView = 'vessels'; // 'vessels' or 'anchorages'
        let currentLocationMarkers = {}; // Store current location markers
        let currentLocationInfoWindows = {}; // Store current location info windows
        let vesselData = []; // Store vessel data from API (array of vessels)
        let vesselPaths = []; // Store path lines between home and current locations
        
        // Location data
        const locations = {
            littleManly: {
                position: { lat: -33.807998, lng: 151.286544 },
                title: "Little Manly Point Reserve",
                vessel: "JUNIOR (12 seater)",
                mooring: "CL8335 (Red Buoy)",
                type: "swing",
                icon: "anchor",
                content: `
                    <div class="info-window">
                        <h3>Little Manly Point Reserve</h3>
                        <div class="vessel-name">JUNIOR - 12 seater</div>
                        <div class="detail"><strong>Mooring:</strong> CL8335 (Red Buoy)</div>
                        <div class="detail"><strong>Type:</strong> Swing Mooring</div>
                        <hr style="margin: 10px 0;">
                        <h4 style="margin: 0.5rem 0;">Access Details:</h4>
                        <div class="detail">🚗 <strong>Parking:</strong> Stuart Street</div>
                        <div class="detail">🛶 <strong>Tender:</strong> Paddle board in racks facing water</div>
                        <div class="detail">📍 <strong>Location:</strong> Near boat ramp</div>
                        <button class="directions-btn" onclick="getDirections(-33.807998, 151.286544, event)" style="margin-top: 10px;">
                            <i class="fas fa-route"></i> Get Directions
                        </button>
                    </div>
                `
            },
            balmoral: {
                position: { lat: -33.826154, lng: 151.254493 },
                title: "Balmoral Beach",
                vessel: "SANDSTONE (8 seater)",
                mooring: "Swing Mooring",
                type: "temp",
                icon: "clock",
                content: `
                    <div class="info-window">
                        <h3>Balmoral Beach</h3>
                        <div class="vessel-name">SANDSTONE - 8 seater</div>
                        <div class="detail"><strong>Type:</strong> Swing Mooring (Temporary)</div>
                        <hr style="margin: 10px 0;">
                        <h4 style="margin: 0.5rem 0;">Access Details:</h4>
                        <div class="detail">🚗 <strong>Parking:</strong> The Esplanade</div>
                        <div class="detail">⚠️ <strong>Status:</strong> Temporary location</div>
                        <div class="detail">📍 <strong>Note:</strong> Check current status</div>
                        <button class="directions-btn" onclick="getDirections(-33.826154, 151.254493, event)" style="margin-top: 10px;">
                            <i class="fas fa-route"></i> Get Directions
                        </button>
                    </div>
                `
            },
            seaforth: {
                position: { lat: -33.804468, lng: 151.239951 },
                title: "Seaforth (via The Spit)",
                vessel: "PUMICESTONE (12 seater)",
                mooring: "CA017/CA023",
                type: "swing",
                icon: "anchor",
                content: `
                    <div class="info-window">
                        <h3>Seaforth Mooring Field</h3>
                        <div class="vessel-name">PUMICESTONE - 12 seater</div>
                        <div class="detail"><strong>Mooring:</strong> CA017/CA023</div>
                        <div class="detail"><strong>Type:</strong> Swing Mooring</div>
                        <hr style="margin: 10px 0;">
                        <h4 style="margin: 0.5rem 0;">Access Details:</h4>
                        <div class="detail">🚗 <strong>Parking:</strong> The Spit West Reserve</div>
                        <div class="detail">🚤 <strong>Tender:</strong> Work Boat near Plonk Cafe</div>
                        <div class="detail">📍 <strong>Navigate:</strong> Through Spit Bridge underpass</div>
                        <div class="detail">⚠️ <strong>Route:</strong> Follow channel alongside Seaforth Crescent</div>
                        <button class="directions-btn" onclick="getDirections(-33.804468, 151.239951, event)" style="margin-top: 10px;">
                            <i class="fas fa-route"></i> Get Directions to The Spit
                        </button>
                    </div>
                `
            },
            dalbora: {
                position: { lat: -33.804802, lng: 151.245358 },
                title: "d'Albora Marina - The Spit",
                vessel: "Ice Cream Boat",
                berth: "AE25",
                type: "marina",
                icon: "building",
                content: `
                    <div class="info-window">
                        <h3>d'Albora Marina - The Spit</h3>
                        <div class="vessel-name">Ice Cream Boat</div>
                        <div class="detail"><strong>Berth:</strong> AE25 (Eastern side of A arm)</div>
                        <div class="detail"><strong>Type:</strong> Marina Berth</div>
                        <hr style="margin: 10px 0;">
                        <h4 style="margin: 0.5rem 0;">Access Details:</h4>
                        <div class="detail">🚗 <strong>Parking:</strong> Marina visitor parking (next to Boat Yard)</div>
                        <div class="detail">🔑 <strong>Access:</strong> FOB key access (5PM - 7:30AM)</div>
                        <div class="detail">⚡ <strong>Important:</strong> Check shore power for ice cream freezer</div>
                        <div class="detail">📍 <strong>Location:</strong> Near Dry Dock</div>
                        <button class="directions-btn" onclick="getDirections(-33.804802, 151.245358, event)" style="margin-top: 10px;">
                            <i class="fas fa-route"></i> Get Directions
                        </button>
                    </div>
                `
            },
            fergusons: {
                position: { lat: -33.804169, lng: 151.246879 },
                title: "Fergusons Marina",
                vessel: "Work Boat",
                type: "marina",
                icon: "building",
                content: `
                    <div class="info-window">
                        <h3>Fergusons Marina</h3>
                        <div class="vessel-name">Work Boat</div>
                        <div class="detail"><strong>Address:</strong> 83 Parriwi Rd, Mosman NSW 2088</div>
                        <div class="detail"><strong>Type:</strong> Marina Berth</div>
                        <hr style="margin: 10px 0;">
                        <h4 style="margin: 0.5rem 0;">Access Details:</h4>
                        <div class="detail">🚗 <strong>Parking:</strong> Marina visitor parking</div>
                        <div class="detail">🔑 <strong>Access:</strong> PIN code access at gate</div>
                        <div class="detail">📍 <strong>Location:</strong> 83 Parriwi Rd, Mosman NSW 2088</div>
                        <div class="detail">⚠️ <strong>Important:</strong> Remember to lock gate after entry</div>
                        <button class="directions-btn" onclick="getDirections(-33.804169, 151.246879, event)" style="margin-top: 10px;">
                            <i class="fas fa-route"></i> Get Directions
                        </button>
                    </div>
                `
            }
        };
        
        // Safe anchorage data
        const anchorages = [
            {
                name: "Forty Baskets Beach",
                position: { lat: -33.803671, lng: 151.270431 },
                radius: 50, // 50 meter radius for visibility (10x10m might be too small to see)
                description: "Protected anchorage suitable for S/SE winds. Popular spot with good holding."
            },
            {
                name: "Collins Beach",
                position: { lat: -33.808391, lng: 151.290998 },
                radius: 50,
                description: "Well-protected from southerly winds. Good holding in sand."
            },
            {
                name: "Store Beach",
                position: { lat: -33.812269, lng: 151.288648 },
                radius: 50,
                description: "Excellent protection from S/SE winds. Popular anchorage with facilities nearby."
            },
            {
                name: "Quarantine Beach",
                position: { lat: -33.814993, lng: 151.286208 },
                radius: 50,
                description: "Historic location with good protection. Suitable for overnight anchoring in southerlies."
            }
        ];
        
        // Fetch vessel data from API including current locations
        async function fetchVesselData() {
            try {
                console.log('Fetching vessel data...');
                const response = await fetch('/api/vessels/maintenance-status');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('API Response:', data);
                
                if (data.success) {
                    vesselData = data.vessels;
                    console.log('Loaded vessel data:', vesselData);
                    
                    // Fixed locations for specific vessels
                    const fixedLocations = {
                        'Work Boat': {
                            latitude: -33.8126,
                            longitude: 151.2738,
                            address: 'Fergusons Marina',
                            captured: true,
                            isFixed: true
                        },
                        'Ice Cream Boat': {
                            latitude: -33.8058,
                            longitude: 151.2485,
                            address: 'Dalbora Marina The Spit, A Arm',
                            captured: true,
                            isFixed: true
                        }
                    };
                    
                    // Override locations for fixed vessels
                    vesselData.forEach(vessel => {
                        if (fixedLocations[vessel.name]) {
                            if (!vessel.currentStatus) {
                                vessel.currentStatus = {};
                            }
                            vessel.currentStatus.location = fixedLocations[vessel.name];
                        }
                    });
                    
                    // Log vessels with location data
                    const vesselsWithLocation = vesselData.filter(v => 
                        v.currentStatus?.location?.captured
                    );
                    console.log(`Found ${vesselsWithLocation.length} vessels with location data:`, vesselsWithLocation);
                    
                    // Update sidebar vessel list
                    updateVesselSidebar();
                    
                    // Update current location markers
                    updateCurrentLocationMarkers();
                } else {
                    console.error('API returned error:', data.error);
                }
            } catch (error) {
                console.error('Error fetching vessel data:', error);
                // Show error message to user
                const mapDiv = document.getElementById('map');
                if (mapDiv && !document.getElementById('fetch-error')) {
                    const errorDiv = document.createElement('div');
                    errorDiv.id = 'fetch-error';
                    errorDiv.style.cssText = `
                        position: absolute;
                        top: 80px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: #ff6b6b;
                        color: white;
                        padding: 10px 20px;
                        border-radius: 5px;
                        z-index: 1000;
                    `;
                    errorDiv.textContent = 'Error loading vessel data. Check console for details.';
                    mapDiv.appendChild(errorDiv);
                }
            }
        }
        
        // Update sidebar with vessel list
        function updateVesselSidebar() {
            const vesselList = document.getElementById('vesselList');
            if (!vesselList) return;
            
            if (!vesselData || vesselData.length === 0) {
                vesselList.innerHTML = '<div class="no-vessels">No vessel data available</div>';
                return;
            }
            
            // Sort vessels by name
            const sortedVessels = [...vesselData].sort((a, b) => a.name.localeCompare(b.name));
            
            // Build vessel cards
            let html = '';
            sortedVessels.forEach(vessel => {
                const hasLocation = vessel.currentStatus?.location?.captured;
                const location = vessel.currentStatus?.location;
                
                // Determine mooring type from home location or current status
                let mooringType = 'Unknown';
                let homeLocation = null;
                
                // Find home location info
                Object.values(locations).forEach(loc => {
                    if (loc.vessel && loc.vessel.toLowerCase().includes(vessel.name.toLowerCase())) {
                        homeLocation = loc;
                        if (loc.title && loc.title.includes('Marina')) {
                            mooringType = 'Marina Berth';
                        } else {
                            mooringType = 'Swing Mooring';
                        }
                    }
                });
                
                html += `
                    <div class="vessel-card" onclick="focusVessel('${vessel.id}')">
                        <div class="vessel-status ${hasLocation ? 'has-location' : ''}"></div>
                        <h3><i class="fas fa-ship"></i> ${vessel.name}</h3>
                        <div class="vessel-location">
                            <i class="fas fa-map-marker-alt"></i>
                            ${hasLocation && location.address ? 
                                location.address.split(',')[0] : 
                                (homeLocation ? homeLocation.title : 'Location Unknown')
                            }
                        </div>
                        <div class="vessel-mooring">
                            <i class="fas fa-anchor"></i> ${mooringType}
                        </div>
                    </div>
                `;
            });
            
            vesselList.innerHTML = html;
        }
        
        // Focus on a specific vessel
        window.focusVessel = function(vesselId) {
            const vessel = vesselData.find(v => v.id === vesselId);
            if (!vessel) return;
            
            const location = vessel.currentStatus?.location;
            
            if (location?.captured && location.latitude && location.longitude) {
                // Show vessel view if not already shown
                if (currentView !== 'vessels') {
                    showVesselView();
                }
                
                // Center map on vessel location
                const position = {
                    lat: location.latitude,
                    lng: location.longitude
                };
                
                map.setCenter(position);
                map.setZoom(17);
                
                // Open the info window for this vessel
                const marker = currentLocationMarkers[vesselId];
                const infoWindow = currentLocationInfoWindows[vesselId];
                
                if (marker && infoWindow) {
                    // Close all other info windows
                    Object.values(infoWindows).forEach(iw => iw.close());
                    Object.values(currentLocationInfoWindows).forEach(iw => iw.close());
                    
                    // Open this vessel's info window
                    infoWindow.open(map, marker);
                }
            } else {
                // No current location, try to find home location
                let homeLocation = null;
                Object.entries(locations).forEach(([key, loc]) => {
                    if (loc.vessel && loc.vessel.toLowerCase().includes(vessel.name.toLowerCase())) {
                        homeLocation = { key, loc };
                    }
                });
                
                if (homeLocation) {
                    focusLocation(homeLocation.key);
                } else {
                    alert(`No location data available for ${vessel.name}`);
                }
            }
        }
        
        // Update markers showing current vessel locations
        function updateCurrentLocationMarkers() {
            console.log('Updating current location markers...');
            
            // Clear existing current location markers
            Object.values(currentLocationMarkers).forEach(marker => marker.setMap(null));
            Object.values(currentLocationInfoWindows).forEach(iw => iw.close());
            currentLocationMarkers = {};
            currentLocationInfoWindows = {};
            
            // Clear existing path lines
            vesselPaths.forEach(path => path.setMap(null));
            vesselPaths = [];
            
            // Add markers for vessels with location data
            if (!Array.isArray(vesselData)) {
                console.error('vesselData is not an array:', vesselData);
                return;
            }
            
            vesselData.forEach(vessel => {
                console.log(`Checking vessel ${vessel.name}:`, vessel.currentStatus);
                
                if (vessel.currentStatus && vessel.currentStatus.location && 
                    vessel.currentStatus.location.captured && 
                    vessel.currentStatus.location.latitude && 
                    vessel.currentStatus.location.longitude) {
                    
                    const location = vessel.currentStatus.location;
                    console.log(`Adding marker for ${vessel.name} at:`, location);
                    
                    // Create a custom marker for current location
                    const marker = new google.maps.Marker({
                        position: {
                            lat: location.latitude,
                            lng: location.longitude
                        },
                        map: currentView === 'vessels' ? map : null,
                        title: `${vessel.name} - Current Location`,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: '#FF0000',
                            fillOpacity: 0.9,
                            strokeColor: '#FFFFFF',
                            strokeWeight: 2,
                            scale: 10
                        },
                        animation: google.maps.Animation.DROP
                    });
                    
                    // Create info window with location details
                    const timeSince = location.isFixed ? 
                        'Marina Berth' :
                        ((location.lastModified || vessel.lastCheck?.time) ? 
                            new Date(location.lastModified || vessel.lastCheck.time).toLocaleString('en-AU', {
                                dateStyle: 'short',
                                timeStyle: 'short'
                            }) : 'Unknown');
                    
                    const updateIcon = location.isFixed ? '🔒' : '📊';
                    
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div class="info-window">
                                <h3>${vessel.name} - Current Location</h3>
                                <div class="vessel-name">${vessel.type}</div>
                                <div class="detail"><strong>📍 Address:</strong> ${location.address || 'Unknown'}</div>
                                <div class="detail"><strong>${updateIcon} Last Updated:</strong> ${timeSince}</div>
                                <hr style="margin: 10px 0;">
                                <div class="detail"><strong>⛽ Fuel:</strong> ${vessel.currentStatus.fuel?.level || 'Unknown'}</div>
                                <div class="detail"><strong>🔥 Gas:</strong> ${vessel.currentStatus.gas?.level || 'Unknown'}</div>
                                <div class="detail"><strong>💧 Water:</strong> ${vessel.currentStatus.water?.level || 'Unknown'}</div>
                                <div class="detail"><strong>🚤 Condition:</strong> ${vessel.currentStatus.condition || 'Unknown'}</div>
                            </div>
                        `
                    });
                    
                    marker.addListener('click', () => {
                        // Close all other info windows
                        Object.values(infoWindows).forEach(iw => iw.close());
                        Object.values(currentLocationInfoWindows).forEach(iw => iw.close());
                        infoWindow.open(map, marker);
                    });
                    
                    currentLocationMarkers[vessel.id] = marker;
                    currentLocationInfoWindows[vessel.id] = infoWindow;
                    
                    // Try to find home location for this vessel
                    let homeLocation = null;
                    Object.values(locations).forEach(loc => {
                        if (loc.vessel && loc.vessel.toLowerCase().includes(vessel.name.toLowerCase())) {
                            homeLocation = loc.position;
                        }
                    });
                    
                    // Draw path line from home to current location
                    if (homeLocation) {
                        const path = new google.maps.Polyline({
                            path: [homeLocation, { lat: location.latitude, lng: location.longitude }],
                            geodesic: true,
                            strokeColor: '#FF0000',
                            strokeOpacity: 0.5,
                            strokeWeight: 2,
                            map: currentView === 'vessels' ? map : null
                        });
                        
                        vesselPaths.push(path);
                    }
                }
            });
        }
        
        function initMap() {
            // Create map centered on Sydney Harbour
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: -33.810856, lng: 151.256586 },
                zoom: 13,
                mapTypeId: 'hybrid',
                mapTypeControl: true,
                mapTypeControlOptions: {
                    style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                    position: google.maps.ControlPosition.TOP_LEFT
                },
                streetViewControl: true,
                fullscreenControl: true
            });
            
            // Create markers for each location
            Object.keys(locations).forEach(key => {
                const location = locations[key];
                
                // Determine marker color based on type
                let markerColor;
                switch(location.type) {
                    case 'swing':
                        markerColor = '3498DB'; // Blue
                        break;
                    case 'marina':
                        markerColor = '27AE60'; // Green
                        break;
                    case 'temp':
                        markerColor = 'F39C12'; // Orange
                        break;
                    default:
                        markerColor = 'E74C3C'; // Red
                }
                
                // Create custom marker icon
                const marker = new google.maps.Marker({
                    position: location.position,
                    map: map,
                    title: location.title,
                    icon: {
                        url: `https://maps.google.com/mapfiles/ms/icons/${markerColor === '27AE60' ? 'green' : markerColor === 'F39C12' ? 'orange' : 'blue'}-dot.png`,
                        scaledSize: new google.maps.Size(40, 40)
                    },
                    animation: google.maps.Animation.DROP
                });
                
                // Create info window
                const infoWindow = new google.maps.InfoWindow({
                    content: location.content
                });
                
                // Add click listener
                marker.addListener('click', () => {
                    // Close all other info windows
                    Object.values(infoWindows).forEach(iw => iw.close());
                    infoWindow.open(map, marker);
                    
                    // Update active card
                    document.querySelectorAll('.location-card').forEach(card => {
                        card.classList.remove('active');
                    });
                    document.querySelectorAll('.location-card')[Object.keys(locations).indexOf(key)].classList.add('active');
                });
                
                markers[key] = marker;
                infoWindows[key] = infoWindow;
            });
            
            // Add custom controls
            const centerButton = document.createElement('button');
            centerButton.textContent = 'Show All Locations';
            centerButton.style.cssText = `
                background: white;
                border: none;
                padding: 8px 16px;
                margin: 10px;
                border-radius: 5px;
                box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                cursor: pointer;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            `;
            centerButton.addEventListener('click', showAllLocations);
            map.controls[google.maps.ControlPosition.TOP_CENTER].push(centerButton);
            
            // Create anchorage circles (hidden by default)
            createAnchorageCircles();
            
            // Fetch vessel data after map loads
            fetchVesselData();
            
            // Auto-refresh vessel data every 60 seconds
            setInterval(fetchVesselData, 60000);
        }
        
        function focusLocation(locationKey) {
            // Check if map is loaded
            if (typeof google === 'undefined' || !map) {
                alert('Map is not loaded. Please add Google Maps API key or use the "Get Directions" button.');
                return;
            }
            
            const location = locations[locationKey];
            const marker = markers[locationKey];
            const infoWindow = infoWindows[locationKey];
            
            // Close all info windows
            Object.values(infoWindows).forEach(iw => iw.close());
            
            // Pan and zoom to location
            map.panTo(location.position);
            map.setZoom(16);
            
            // Open info window
            infoWindow.open(map, marker);
            
            // Bounce marker
            marker.setAnimation(google.maps.Animation.BOUNCE);
            setTimeout(() => {
                marker.setAnimation(null);
            }, 1500);
            
            // Update active card
            document.querySelectorAll('.location-card').forEach(card => {
                card.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
        }
        

        
        window.getDirections = function(lat, lng, event) {
            // Open Google Maps with directions
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            window.open(url, '_blank');
            if (event) {
                event.stopPropagation();
            }
        }
        
        // Create anchorage circles
        function createAnchorageCircles() {
            anchorages.forEach(anchorage => {
                const circle = new google.maps.Circle({
                    strokeColor: '#E74C3C',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#E74C3C',
                    fillOpacity: 0.35,
                    map: null, // Hidden by default
                    center: anchorage.position,
                    radius: anchorage.radius,
                    clickable: true
                });
                
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div class="info-window">
                            <h3>${anchorage.name}</h3>
                            <p style="margin: 0.5rem 0;">${anchorage.description}</p>
                            <div class="detail"><strong>Protection:</strong> S/SE winds</div>
                            <div class="detail"><strong>Max Wind:</strong> 20+ knots</div>
                        </div>
                    `
                });
                
                circle.addListener('click', () => {
                    infoWindow.setPosition(anchorage.position);
                    infoWindow.open(map);
                });
                
                anchorageCircles.push({ circle, infoWindow });
            });
        }
        
        // Show vessel view
        function showVesselView() {
            currentView = 'vessels';
            
            // Update toggle buttons
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.toggle-btn').classList.add('active');
            
            // Show vessel markers (home locations)
            Object.values(markers).forEach(marker => marker.setMap(map));
            
            // Show current location markers
            Object.values(currentLocationMarkers).forEach(marker => marker.setMap(map));
            
            // Show vessel paths
            vesselPaths.forEach(path => path.setMap(map));
            
            // Hide anchorage circles
            anchorageCircles.forEach(item => {
                item.circle.setMap(null);
                item.infoWindow.close();
            });
            
            // Update legends
            document.querySelector('.vessel-legend').classList.remove('hidden');
            document.querySelector('.anchorage-legend').classList.remove('active');
            
            // Show sidebar
            document.querySelector('.sidebar').style.display = 'block';
            
            // Reset view to show all vessels
            showAllLocations();
        }
        
        // Show anchorage view
        function showAnchorageView() {
            currentView = 'anchorages';
            
            // Update toggle buttons
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.toggle-btn').classList.add('active');
            
            // Hide vessel markers
            Object.values(markers).forEach(marker => marker.setMap(null));
            Object.values(infoWindows).forEach(iw => iw.close());
            
            // Hide current location markers
            Object.values(currentLocationMarkers).forEach(marker => marker.setMap(null));
            Object.values(currentLocationInfoWindows).forEach(iw => iw.close());
            
            // Hide vessel paths
            vesselPaths.forEach(path => path.setMap(null));
            
            // Show anchorage circles
            anchorageCircles.forEach(item => item.circle.setMap(map));
            
            // Update legends
            document.querySelector('.vessel-legend').classList.add('hidden');
            document.querySelector('.anchorage-legend').classList.add('active');
            
            // Hide sidebar
            document.querySelector('.sidebar').style.display = 'none';
            
            // Fit map to show all anchorages
            const bounds = new google.maps.LatLngBounds();
            anchorages.forEach(anchorage => {
                bounds.extend(anchorage.position);
            });
            map.fitBounds(bounds);
        }
        
        // Modified showAllLocations to respect current view
        function showAllLocations() {
            if (currentView === 'vessels') {
                // Create bounds to include all markers
                const bounds = new google.maps.LatLngBounds();
                
                // Include home location markers
                Object.values(markers).forEach(marker => {
                    bounds.extend(marker.getPosition());
                });
                
                // Include current location markers
                Object.values(currentLocationMarkers).forEach(marker => {
                    bounds.extend(marker.getPosition());
                });
                
                // Only fit bounds if we have markers
                if (bounds.getNorthEast() && bounds.getSouthWest()) {
                    map.fitBounds(bounds);
                }
                
                // Close all info windows
                Object.values(infoWindows).forEach(iw => iw.close());
                Object.values(currentLocationInfoWindows).forEach(iw => iw.close());
                
                // Remove active class from all cards
                document.querySelectorAll('.location-card').forEach(card => {
                    card.classList.remove('active');
                });
            } else {
                // Show all anchorages
                const bounds = new google.maps.LatLngBounds();
                anchorages.forEach(anchorage => {
                    bounds.extend(anchorage.position);
                });
                map.fitBounds(bounds);
            }
        }
        
        // Initialize map when page loads
        window.onload = function() {
            // Show all locations by default after map loads
            if (typeof google !== 'undefined' && map) {
                setTimeout(showAllLocations, 1000);
            }
        };
    </script>
    
    <!-- Google Maps JavaScript API -->
        <!-- Google Maps API -->
    <!-- SECURITY: API key should be added via environment variable or restricted in Google Cloud Console -->
    <script>
        // Temporary solution - the API key should be restricted to this domain in Google Cloud Console
        const GOOGLE_MAPS_API_KEY = 'AIzaSyBbjgKhMV5I1nwWa8pCf7m-_7G1dz8EDbw';
        
        // Create and load the Google Maps script
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap&libraries=&v=weekly`;
        script.async = true;
        script.defer = true;
        script.onerror = function() {
            console.error('Failed to load Google Maps. Please check API key and restrictions.');
            // Show fallback message
            document.getElementById('map').innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <h3>Map temporarily unavailable</h3>
                    <p>Please use the "Get Directions" buttons for navigation.</p>
                    <p style="color: #888; font-size: 0.9em;">If you're an admin, check the console for details.</p>
                </div>
            `;
        };
        document.head.appendChild(script);
    </script>
</body>
</html> 