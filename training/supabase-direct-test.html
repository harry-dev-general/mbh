<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Direct Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #f5f5f5;
        }
        .test {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre {
            background: #f0f0f0;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Supabase Direct Connection Test</h1>
    <div id="results"></div>

    <script>
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = `[${new Date().toISOString()}] ${message}`;
            results.appendChild(div);
        }

        async function runTests() {
            log('Starting Supabase direct connection tests...');
            
            try {
                // Test 1: Direct API call to Supabase
                log('Test 1: Making direct API call to Supabase...');
                const url = 'https://etkugeooigiwahikrmzr.supabase.co';
                const anonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0a3VnZW9vaWdpd2FoaWtybXpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4MDI0OTcsImV4cCI6MjA2ODM3ODQ5N30.OPIYLsnPNNF7dP3SDCODIurzaa3X_Q3xEhfPO3rLJxU';
                
                const response = await fetch(`${url}/rest/v1/`, {
                    headers: {
                        'apikey': anonKey,
                        'Authorization': `Bearer ${anonKey}`
                    }
                });
                
                log(`Direct API response status: ${response.status}`, response.ok ? 'success' : 'error');
                
                // Test 2: Load Supabase JS library
                log('Test 2: Loading Supabase JS library...');
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                
                await new Promise((resolve, reject) => {
                    script.onload = () => {
                        log('Supabase library loaded successfully', 'success');
                        resolve();
                    };
                    script.onerror = (error) => {
                        log('Failed to load Supabase library: ' + error, 'error');
                        reject(error);
                    };
                    document.head.appendChild(script);
                });
                
                // Test 3: Create Supabase client
                log('Test 3: Creating Supabase client...');
                const supabase = window.supabase.createClient(url, anonKey, {
                    auth: {
                        persistSession: false,
                        autoRefreshToken: false
                    }
                });
                log('Supabase client created', 'success');
                
                // Test 4: Check if we can call getSession without hanging
                log('Test 4: Testing getSession with timeout...');
                const sessionPromise = supabase.auth.getSession();
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout after 5 seconds')), 5000)
                );
                
                try {
                    const result = await Promise.race([sessionPromise, timeoutPromise]);
                    log('getSession completed successfully', 'success');
                    log(`Session data: <pre>${JSON.stringify(result, null, 2)}</pre>`);
                } catch (error) {
                    if (error.message.includes('Timeout')) {
                        log('getSession timed out - THIS IS THE ISSUE!', 'error');
                    } else {
                        log(`getSession error: ${error.message}`, 'error');
                    }
                }
                
                // Test 5: Try alternative session check
                log('Test 5: Testing alternative session check methods...');
                
                // Method 1: onAuthStateChange
                log('Method 1: Using onAuthStateChange...');
                let authStateReceived = false;
                const { data: authListener } = supabase.auth.onAuthStateChange((event, session) => {
                    authStateReceived = true;
                    log(`Auth state change: ${event}, session: ${!!session}`, 'success');
                });
                
                // Wait 2 seconds for auth state
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                if (!authStateReceived) {
                    log('No auth state change received after 2 seconds', 'error');
                }
                
                authListener.subscription.unsubscribe();
                
                // Method 2: Direct REST API call
                log('Method 2: Direct REST API call to check session...');
                try {
                    const token = localStorage.getItem(`sb-${url.split('//')[1].split('.')[0]}-auth-token`);
                    if (token) {
                        log('Found stored token, verifying...', 'info');
                        const verifyResponse = await fetch(`${url}/auth/v1/user`, {
                            headers: {
                                'apikey': anonKey,
                                'Authorization': `Bearer ${JSON.parse(token).access_token}`
                            }
                        });
                        log(`Token verification status: ${verifyResponse.status}`, verifyResponse.ok ? 'success' : 'error');
                    } else {
                        log('No stored token found', 'info');
                    }
                } catch (error) {
                    log(`Direct API error: ${error.message}`, 'error');
                }
                
            } catch (error) {
                log(`Test suite error: ${error.message}`, 'error');
                console.error(error);
            }
            
            log('All tests completed.');
        }
        
        runTests();
    </script>
</body>
</html>
