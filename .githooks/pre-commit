#!/bin/bash
#
# Pre-commit hook for MBH Staff Portal
# Prevents committing secrets and API keys
#

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "üîç Running pre-commit security checks..."

# Flag to track if we found any issues
FOUND_ISSUE=0

# Check for potential API keys
echo -n "  Checking for API keys... "
if git diff --cached --no-ext-diff | grep -E "pat[A-Za-z0-9]{8,}\.|sk_test_|sk_live_|EAA[A-Za-z0-9]+|sq0[a-z]{3}-[A-Za-z0-9-]+|AIza[0-9A-Za-z-_]{35}" > /dev/null; then
    echo -e "${RED}FOUND${NC}"
    echo ""
    echo -e "${RED}‚ùå Potential API key detected in commit!${NC}"
    echo "   Common patterns detected:"
    echo "   - Airtable: pat*.xxxxxxxxx"
    echo "   - Square: sq0xxx-xxxxx or EAAxxxxx"
    echo "   - Google Maps: AIzaxxxxx"
    echo ""
    FOUND_ISSUE=1
else
    echo -e "${GREEN}OK${NC}"
fi

# Check for JWT tokens
echo -n "  Checking for JWT tokens... "
if git diff --cached --no-ext-diff | grep -E "eyJ[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+" > /dev/null; then
    echo -e "${RED}FOUND${NC}"
    echo ""
    echo -e "${RED}‚ùå JWT token detected in commit!${NC}"
    echo "   Remove Supabase anon/service keys and use environment variables"
    echo ""
    FOUND_ISSUE=1
else
    echo -e "${GREEN}OK${NC}"
fi

# Check for hardcoded credentials in URLs
echo -n "  Checking for credentials in URLs... "
if git diff --cached --no-ext-diff | grep -E "apikey=|api_key=|access_token=|auth_token=|password=|secret=" > /dev/null; then
    echo -e "${RED}FOUND${NC}"
    echo ""
    echo -e "${RED}‚ùå Hardcoded credential detected in URL!${NC}"
    echo "   Move credentials to environment variables"
    echo ""
    FOUND_ISSUE=1
else
    echo -e "${GREEN}OK${NC}"
fi

# Check for Twilio credentials
echo -n "  Checking for Twilio credentials... "
if git diff --cached --no-ext-diff | grep -E "AC[a-z0-9]{32}|SK[a-z0-9]{32}" > /dev/null; then
    echo -e "${RED}FOUND${NC}"
    echo ""
    echo -e "${RED}‚ùå Twilio credential detected!${NC}"
    echo ""
    FOUND_ISSUE=1
else
    echo -e "${GREEN}OK${NC}"
fi

# Check for admin key defaults
echo -n "  Checking for default admin keys... "
if git diff --cached --no-ext-diff | grep -E "mbh-admin-2025|admin-key-default|test-admin-key" > /dev/null; then
    echo -e "${YELLOW}WARNING${NC}"
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  Default admin key pattern detected${NC}"
    echo "   Ensure you're not using default keys in production"
    echo ""
fi

# Check for test files being committed
echo -n "  Checking for test files... "
TEST_FILES=$(git diff --cached --name-only | grep -E "(-test\.html|test-.*\.html|auth-no-check\.html)" || true)
if [ ! -z "$TEST_FILES" ]; then
    echo -e "${YELLOW}WARNING${NC}"
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  Test files detected in commit:${NC}"
    echo "$TEST_FILES" | sed 's/^/     - /'
    echo "   Consider if these should be committed"
    echo ""
fi

# Final result
echo ""
if [ $FOUND_ISSUE -eq 1 ]; then
    echo -e "${RED}‚ùå COMMIT BLOCKED: Security issues detected${NC}"
    echo ""
    echo "To fix:"
    echo "1. Remove the detected secrets from your staged files"
    echo "2. Use environment variables instead"
    echo "3. Update your code to load from /api/config endpoint"
    echo ""
    echo "If this is a false positive, you can bypass with:"
    echo "  git commit --no-verify"
    echo ""
    exit 1
else
    echo -e "${GREEN}‚úÖ All security checks passed${NC}"
fi

exit 0
